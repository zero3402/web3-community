# =============================================================================
# ğŸ“¡ Kafka Service Configuration
# =============================================================================
# ì„¤ëª…: Kafka ë¸Œë¡œì»¤ ë° í† í”½ ì„¤ì •ì„ ìœ„í•œ ìŠ¤í”„ë§ ë¶€íŠ¸ ì½˜í”¼ê·œë ˆì´ì…˜
# ëª©ì : ë¸Œë¡œì»¤ë³„ í† í”½ ì„¤ì •, ì»¨ìŠˆë¨¸ ê·¸ë£¹, ì‹œë¦¬ì–¼ë¼ì´ì €
# íŠ¹ì§•: ì¬ì‹œë„ ì „ëœì˜¬ë ¥, ë³´ì•ˆ, ì„±ëŠ¥ ìµœì í™”
# =============================================================================

# =============================================================================
# ğŸ“¡ ê¸°ë³¸ ì¹´í”„ì¹´ ì„¤ì •
# =============================================================================
spring:
  kafka:
    # =============================================================================
    # ğŸ“¡ ë¸Œë¡œì»¤ ì„œë²„ ì„¤ì • (ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë‹¤ë¥¸ ë¸Œë¡œì»¤ ì—°ê²°)
    # =============================================================================
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:kafka-service:9092}
    security:
      protocol: SASL_PLAINTEXT
      mechanisms: PLAIN
    sasl:
      jaas:
        username: ${KAFKA_SASL_USERNAME:kafkaclient}
        password: ${KAFKA_SASL_PASSWORD:kafkaclientpass}
    
    # =============================================================================
    # ğŸ“‹ í”„ë¡œë“€ì„œ ì„¤ì •
    # =============================================================================
    producer:
      # ì¬ì‹œë„ ì„¤ì • (ì¤‘ìš”!)
      retries: 3
      acks: all  # ëª¨ë“  ë¦¬í”Œë¦¬ì¹´ê°€ í™•ì¸ë  ë•Œê¹Œì§€ ëŒ€ê¸°
      delivery-timeout: 30000  # 30ì´ˆ
      linger-ms: 0  # ë©”ì‹œì§€ ì „ì†¡ í›„ ë°”ë¡œ ë¦¬í„´
      batch-size: 1  # ë°°ì¹˜ í¬ê¸° (ë‚˜ì¤‘ì— ë§ì¶¤)
      
      # ì••ì¶• ì„¤ì •
      compression-type: gzip
      properties:
        # ë©”ì‹œì§€ í‚¤ ì§ë ¬í™” (ì„ íƒì )
        key.serializer: org.apache.kafka.common.serialization.StringSerializer
        value.serializer: org.apache.kafka.common.serialization.StringSerializer
        
        # ì„±ëŠ¥ ìµœì í™”
        buffer.memory: 33554432  # 32MB ë²„í¼
        batch.size: 16384      # 16KB ë°°ì¹˜ í¬ê¸°
        linger.ms: 5         # 5ms ë™ì•ˆ ë©”ì‹œì§€ ëª¨ì•„
        
        # ë³´ì•ˆ ì„¤ì •
        security.protocol: SASL_PLAINTEXT
        sasl.mechanism: PLAIN
        sasl.jaas.username: ${KAFKA_SASL_USERNAME:kafkaclient}
        sasl.jaas.password: ${KAFKA_SASL_PASSWORD:kafkaclientpass}
    
    # =============================================================================
    # ğŸ“¥ ì»¨ìŠˆë¨¸ ì„¤ì •
    # =============================================================================
    consumer:
      # ê·¸ë£¹ ID ì„¤ì • (ì¤‘ìš”!)
      group-id: ${KAFKA_CONSUMER_GROUP:notification-service}
      
      # ì˜¤í”„ì…‹ ì´ˆê¸° ì„¤ì •
      auto-offset-reset: earliest
      enable-auto-commit: false  # ìˆ˜ë™ ì˜¤í”„ì…‹ ì œì–´
      key-deserializer: org.apache.kafka.common.serialization.StringSerializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      
      # ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ì„¤ì •
      max-poll-records: 100
      poll-timeout: 1000
      session-timeout-ms: 30000
      heartbeat-interval-ms: 3000
      
      # ë‚´ê²°ì„± ì²˜ë¦¬ëŸ‰ ì œì–´
      max-poll-interval-ms: 5000
      fetch-max-bytes: 1048576  # 1MB
      fetch-min-bytes: 1
      
      # ì¬ì‹œë„ ì„¤ì •
      retry:
        max-attempts: 3
        backoff:
          delay: 1000
          max-delay: 10000
          multiplier: 2
      
      # ë³´ì•ˆ ì„¤ì •
      properties:
        security.protocol: SASL_PLAINTEXT
        sasl.mechanism: PLAIN
        sasl.jaas.username: ${KAFKA_SASL_USERNAME:kafkaclient}
        sasl.jaas.password: ${KAFKA_SASL_PASSWORD:kafkaclientpass}
        
        # ì„±ëŠ¥ ìµœì í™”
        fetch.min.bytes: 1
        fetch.max.wait.ms: 500
        max.partition.fetch.bytes: 1048576
        
        # íŠ¸ëœì­ì…˜ ê²©ë¦¬ë¥¼ ìœ„í•œ ì•„ì´ì†Œë ˆì´ì…˜ ì„¤ì •
        isolation.level: read_committed
        auto.commit.interval.ms: 1000
        
        # ë””ë²„ê¹…
        client.id: ${spring.application.name}-${random.uuid}

# =============================================================================
# ğŸ“‹ í† í”½ ì„¤ì • (ì• í”Œë¦¬ì¼€ì´ì…˜ë³„)
# =============================================================================
web3:
  kafka:
    topics:
      # =============================================================================
      # ğŸ“ ê²Œì‹œê¸€ ê´€ë ¨ í† í”½
      # =============================================================================
      posts:
        name: ${KAFKA_TOPIC_POSTS:posts}
        partitions: 3
        replication-factor: 1
        config:
          cleanup.policy: delete
          retention.ms: 2592000000  # 30ì¼
          segment.ms: 86400000       # 1ì¼
          max.message.bytes: 10485760  # 10MB
          compression.type: producer
      
      post-events:
        name: ${KAFKA_TOPIC_POST_EVENTS:post-events}
        partitions: 3
        replication-factor: 1
        config:
          cleanup.policy: compact
          retention.ms: 604800000   # 7ì¼
          segment.ms: 86400000     # 1ì¼
          max.message.bytes: 5242880  # 5MB
      
      post-analytics:
        name: ${KAFKA_TOPIC_POST_ANALYTICS:post-analytics}
        partitions: 2
        replication-factor: 1
        config:
          cleanup.policy: delete
          retention.ms: 5184000000  # 60ì¼
          segment.bytes: 1073741824     # 1GB
      
      # =============================================================================
      # ğŸ’¬ ëŒ“ê¸€ ê´€ë ¨ í† í”½
      # =============================================================================
      comments:
        name: ${KAFKA_TOPIC_COMMENTS:comments}
        partitions: 3
        replication-factor: 1
        config:
          cleanup.policy: delete
          retention.ms: 2592000000  # 30ì¼
          segment.ms: 86400000       # 1ì¼
          max.message.bytes: 10485760  # 10MB
      
      comment-events:
        name: ${KAFKA_TOPIC_COMMENT_EVENTS:comment-events}
        partitions: 3
        replication-factor: 1
        config:
          cleanup.policy: compact
          retention.ms: 604800000   # 7ì¼
          segment.ms: 86400000     # 1ì¼
          max.message.bytes: 5242880  # 5MB
      
      # =============================================================================
      # ğŸ‘¥ ì‚¬ìš©ì ê´€ë ¨ í† í”½
      # =============================================================================
      user-events:
        name: ${KAFKA_TOPIC_USER_EVENTS:user-events}
        partitions: 3
        replication-factor: 1
        config:
          cleanup.policy: delete
          retention.ms: 5184000000  # 60ì¼
          segment.ms: 86400000     # 1ì¼
          max.message.bytes: 10485760  # 10MB
      
      user-profile-updates:
        name: ${KAFKA_TOPIC_USER_PROFILE_UPDATES:user-profile-updates}
        partitions: 2
        replication-factor: 1
        config:
          cleanup.policy: compact
          retention.ms: 777600000  # 90ì¼
          segment.ms: 86400000     # 1ì¼
          max.message.bytes: 2097152  # 2MB
      
      # =============================================================================
      # ğŸ”” ì•Œë¦¼ ê´€ë ¨ í† í”½
      # =============================================================================
      notifications:
        name: ${KAFKA_TOPIC_NOTIFICATIONS:notifications}
        partitions: 5
        replication-factor: 1
        config:
          cleanup.policy: delete
          retention.ms: 604800000   # 7ì¼
          segment.ms: 86400000     # 1ì¼
          max.message.bytes: 5242880  # 5MB
          compression.type: producer
      
      notification-priority:
        name: ${KAFKA_TOPIC_NOTIFICATION_PRIORITY:notification-priority}
        partitions: 3
        replication-factor: 1
        config:
          cleanup.policy: delete
          retention.ms: 259200000   # 30ì¼
          segment.ms: 86400000     # 1ì¼
          max.message.bytes: 10485760  # 10MB
          compression.type: producer
      
      # =============================================================================
      # ğŸ“Š ì‹œìŠ¤í…œ ì´ë²¤íŠ¸
      # =============================================================================
      system-events:
        name: ${KAFKA_TOPIC_SYSTEM_EVENTS:system-events}
        partitions: 3
        replication-factor: 1
        config:
          cleanup.policy: delete
          retention.ms: 7776000000  # 90ì¼
          segment.ms: 86400000     # 1ì¼
          max.message.bytes: 10485760  # 10MB
          compression.type: producer
      
      audit-logs:
        name: ${KAFKA_TOPIC_AUDIT_LOGS:audit-logs}
        partitions: 2
        replication-factor: 1
        config:
          cleanup.policy: delete
          retention.ms: 15552000000  # 180ì¼
          segment.ms: 86400000     # 1ì¼
          max.message.bytes: 5242880  # 5MB
          compression.type: producer
      
      # =============================================================================
      # ğŸ” ë³´ì•ˆ ê´€ë ¨ ì´ë²¤íŠ¸
      # =============================================================================
      security-events:
        name: ${KAFKA_TOPIC_SECURITY_EVENTS:security-events}
        partitions: 3
        replication-factor: 1
        config:
          cleanup.policy: delete
          retention.ms: 5184000000  # 60ì¼
          segment.ms: 86400000     # 1ì¼
          max.message.bytes: 10485760  # 10MB
          compression.type: producer
          message.format.version: 2
          ssl: true

# =============================================================================
# ğŸ¯ Spring Cloud Stream ì„¤ì •
# =============================================================================
spring:
  cloud:
    stream:
      # =============================================================================
      # ğŸ“¥ ë°”ì¸ë”© ì„¤ì •
      # =============================================================================
      kafka:
        binder:
          brokers: ${spring.kafka.bootstrap-servers}
          auto-create-topics: true
          producer:
            configuration:
              security:
                protocol: SASL_PLAINTEXT
                sasl:
                  mechanism: PLAIN
                  jaas:
                    username: ${KAFKA_SASL_USERNAME:kafkaclient}
                    password: ${KAFKA_SASL_PASSWORD:kafkaclientpass}
          
          # ê³µí†µ ì„¤ì •
          default-replication-factor: 1
          min-partition-count: 3
          auto-add-partitions: true
          
          # ì„±ëŠ¥ ì„¤ì •
          producer:
            configuration:
              acks: all
              retries: 3
              batch-size: 16384
              linger-ms: 5
              compression-type: gzip
              buffer.memory: 33554432
          
          # ì»¨ìŠˆë¨¸ ì„¤ì •
          consumer:
            configuration:
              auto-offset-reset: earliest
              enable-auto-commit: false
              session.timeout.ms: 30000
              max-poll-records: 100
              poll-timeout: 1000
              fetch-min-bytes: 1
              fetch-max-wait-ms: 500
              heartbeat-interval-ms: 3000
              security:
                protocol: SASL_PLAINTEXT
                sasl:
                  mechanism: PLAIN
                  jaas:
                    username: ${KAFKA_SASL_USERNAME:kafkaclient}
                    password: ${KAFKA_SASL_PASSWORD:kafkaclientpass}

# =============================================================================
# ğŸ“Š ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • (Spring Boot Cloud Stream)
# =============================================================================
spring:
  application:
    name: notification-service
  profiles:
      active: ${SPRING_PROFILES_ACTIVE:kubernetes}

# Web3 Community Platform Notification Service ì„¤ì •
web3:
  notification:
    # =============================================================================
    # ğŸ“§ ì•Œë¦¼ ì„œë¹„ìŠ¤ ì„¤ì •
    # =============================================================================
    email:
      enabled: ${EMAIL_ENABLED:false}
      smtp:
        host: ${EMAIL_HOST:smtp.gmail.com}
        port: ${EMAIL_PORT:587}
        username: ${EMAIL_USERNAME:}
        password: ${EMAIL_PASSWORD:}
        properties:
          mail:
            smtp:
              auth: true
              starttls:
                enable: ${EMAIL_STARTTLS_ENABLED:true}
                required: true
              ssl:
                  trust: ${EMAIL_SSL_TRUST:*}
    
    # =============================================================================
    # ğŸ“± ëª¨ë°”ì¼ ì•Œë¦¼ ì„¤ì •
    # =============================================================================
    mobile:
      enabled: true
      fcm:
        enabled: false
        server-key: ${FCM_SERVER_KEY:}
        sender-id: ${FCM_SENDER_ID:}
      apns:
        enabled: false
        team-id: ${APNS_TEAM_ID}
        key-path: ${APNS_KEY_PATH}
        key-password: ${APNS_KEY_PASSWORD:}
    
    # =============================================================================
    # ğŸ“Š í‘¸ì‹œ ì•Œë¦¼ ì„¤ì • (ê³ ë ¤ì‚¬í•­)
    # =============================================================================
    push:
      enabled: true
      vapid:
        public-key: ${VAPID_PUBLIC_KEY:}
        private-key: ${VAPID_PRIVATE_KEY}
        subject: "Web3 Community ì•Œë¦¼"
    
    # =============================================================================
    # â° ì•Œë¦¼ ì±„ë„ ì„¤ì •
    # =============================================================================
    channels:
      in-app:
        enabled: true
        max-queue-size: 100
        batch-size: 10
      email:
        enabled: true
        batch-size: 50
        async: true
      push:
        enabled: true
        batch-size: 10
      websocket:
        enabled: true

    # =============================================================================
    # ğŸ“Š ì•Œë¦¼ ì±„ë„ ì„¤ì •
    # =============================================================================
    channels:
      in-app:
        enabled: true
        max-queue-size: 100
        batch-size: 10
      email:
        enabled: true
        batch-size: 50
        async: true
      push:
        enabled: true
        batch-size: 10
      websocket:
        enabled: true

    # =============================================================================
    # â° ì•Œë¦¼ ê·œì¹™ ì„¤ì •
    # =============================================================================
    rules:
      post-created:
        channels: [in-app, email, push]
        template: post-created
        priority: high
        rate-limit:
          per-user: 5 per minute
      comment-replied:
        channels: [in-app, email]
        template: comment-replied
        priority: medium
      like-received:
        channels: [in-app]
        template: like-received
        priority: low
        rate-limit:
          per-user: 10 per minute
      mention:
        channels: [in-app, email]
        template: mention
        priority: high
      system-maintenance:
        channels: [in-app, email, push]
        template: system-maintenance
        priority: critical
        
      # =============================================================================
      # ğŸ•’ ì•Œë¦¼ ì •ì±… (ì°¨ë‹¨/í—ˆìš©)
      # =============================================================================
      policies:
        rate-limiting:
          enabled: true
          default-limit: 10 per minute
          premium-user-limit: 100 per minute
        
        quiet-hours:
          enabled: true
          start-time: "22:00"
          end-time: "08:00"
          timezone: "Asia/Seoul"
          
        content-filtering:
          enabled: true
          blocked-words: [spam, inappropriate, violation]
          
        notification-cooldown:
          enabled: true
          duration: 5 # minutes
          per-type:
            post: 10 minutes
            comment: 5 minutes
            like: 1 minute

# =============================================================================
# ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì„¤ì •
# =============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,kafka,bindings
  endpoint:
    health:
      kafka:
        show-details: always
        probes:
          enabled: true
          
  metrics:
    export:
      kafka:
        enabled: true
      jvm:
        enabled: true
      system:
        enabled: true

# =============================================================================
# ğŸ“ ë¡œê¹… ì„¤ì •
# =============================================================================
logging:
  level:
    com.web3.community: DEBUG
    org.springframework.kafka: INFO
    org.apache.kafka: WARN
    org.springframework.cloud.stream: INFO
    
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  
  file:
    name: logs/notification-service.log
    max-size: 100MB
    max-history: 30
    
  # =============================================================================
  # ğŸ› ë¡œê±°ë°± ì„¤ì • (ì„ íƒì‚¬í•­)
  # =============================================================================
  logback:
    appender:
      stdout:
        encoder:
          pattern: ${CONSOLE_LOG_PATTERN}
          output:
            charset: UTF-8
            
      file:
        fileName: logs/notification-service.log
        maxFileSize: 100MB
        maxHistory: 30
        encoder:
          pattern: ${FILE_LOG_PATTERN}
          output:
            charset: UTF-8
            
      async:
        name: asyncAppender
        queueCapacity: 1000
        discardingThreshold: 0
        includeCallerData: true
        appender-ref: file
        
# =============================================================================
# ğŸ”’ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
# =============================================================================
---
spring:
  profiles:
    test:
      kafka:
        bootstrap-servers: localhost:9092
        consumer:
          group-id: test-group
          auto-offset-reset: earliest
          
  web3:
    notification:
      email:
        enabled: false
      push:
        enabled: false