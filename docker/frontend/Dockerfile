# =============================================================================
# ğŸ³ Frontend Dockerfile (Vue.js 3)
# =============================================================================
# ì„¤ëª…: Vue.js 3 í”„ë¡ íŠ¸ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ ìµœì í™” Docker ì´ë¯¸ì§€
# ëª©ì : ë©€í‹° ìŠ¤í…Œì´ì§€ ë¹Œë“œë¡œ ìµœì†Œí•œì˜ í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ìƒì„±
# íŠ¹ì§•: ê°œë°œ í™˜ê²½ê³¼ í”„ë¡œë•ì…˜ í™˜ê²½ ë¶„ë¦¬, í•« ë¦¬ë¡œë“œ ì§€ì›
# ì‹¤ë¬´ íŒ: BuildKit ì‚¬ìš©, ìºì‹œ ìµœì í™”, ë³´ì•ˆ ê°•í™”
# =============================================================================

# =============================================================================
# ğŸ—ï¸ ë¹Œë“œ ìŠ¤í…Œì´ì§€ (ê°œë°œ/ë¹Œë“œ í™˜ê²½)
# =============================================================================
# ì‚¬ìš©í•  ë…¸ë“œ ì´ë¯¸ì§€ (LTS ë²„ì „ìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´)
FROM node:18-alpine AS builder

# ë¹Œë“œ ìŠ¤í…Œì´ì§€ ë¼ë²¨ (ì»¨í…Œì´ë„ˆ ì‹ë³„ìš©)
LABEL stage=builder \
      service=frontend \
      technology=vue3

# =============================================================================
# ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ í™˜ê²½ ì„¤ì •
# =============================================================================
# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# âš¡ ë¹Œë“œ ì†ë„ ìµœì í™”: package.jsonê³¼ package-lock.json ë¨¼ì € ë³µì‚¬
# ì´ë ‡ê²Œ í•˜ë©´ ì½”ë“œ ë³€ê²½ ì‹œ ì˜ì¡´ì„± ì¬ì„¤ì¹˜ ë°©ì§€ (ìºì‹œ í™œìš©)
COPY package*.json ./

# ğŸ“‹ ì˜ì¡´ì„± ì„¤ì¹˜ (ì‹œê°„ ì ˆì•½ì„ ìœ„í•œ npm ìµœì í™” ì˜µì…˜)
RUN npm ci --only=production --no-audit --no-fund && \
    npm cache clean --force

# ğŸ”§ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# ğŸ¨ í”„ë¡œë•ì…˜ ë¹Œë“œ ì‹¤í–‰
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ë¹Œë“œ íƒ€ì„)
ARG NODE_ENV=production
ARG VUE_APP_API_BASE_URL=http://localhost:8080

ENV NODE_ENV=${NODE_ENV} \
    VUE_APP_API_BASE_URL=${VUE_APP_API_BASE_URL}

# Vue.js í”„ë¡œë•ì…˜ ë¹Œë“œ
RUN npm run build

# =============================================================================
# ğŸš€ í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ (ì‹¤í–‰ í™˜ê²½)
# =============================================================================
# ìµœì†Œí•œì˜ ì›¹ì„œë²„ ì´ë¯¸ì§€ (Nginx Alpine)
FROM nginx:alpine AS production

# í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=production \
      service=frontend \
      technology=nginx

# =============================================================================
# ğŸ”§ Nginx ì„¤ì • ìµœì í™”
# =============================================================================
# ê¸°ë³¸ Nginx ì„¤ì • ì œê±°
RUN rm /etc/nginx/conf.d/default.conf

# ìµœì í™”ëœ Nginx ì„¤ì • ë³µì‚¬ (ë³„ë„ íŒŒì¼ í•„ìš”ì‹œ)
# COPY nginx.conf /etc/nginx/nginx.conf
# COPY default.conf /etc/nginx/conf.d/

# =============================================================================
# ğŸ“¦ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
# =============================================================================
# ë¹Œë“œ ê²°ê³¼ë¬¼ ë³µì‚¬ (ì •ì  íŒŒì¼ë“¤)
COPY --from=builder /app/dist /usr/share/nginx/html

# ì†Œìœ ì ë³€ê²½ (ë³´ì•ˆ)
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html

# =============================================================================
# ğŸŒ ì‹¤í–‰ ì„¤ì •
# =============================================================================
# Nginx ì‹¤í–‰ì„ ìœ„í•œ ë¹„ë°€ë²ˆí˜¸ ì—†ëŠ” ì‚¬ìš©ì ì„¤ì • (ë³´ì•ˆ)
RUN addgroup -g 1001 -S nginx && \
    adduser -S nginx -u 1001

# Nginxê°€ ì‚¬ìš©í•  í¬íŠ¸ (HTTP)
EXPOSE 80

# Nginx ì„¤ì • ë¦¬ë¡œë“œë¥¼ ìœ„í•œ ì‹ í˜¸ ì²˜ë¦¬
STOPSIGNAL SIGTERM

# =============================================================================
# ğŸ¯ ì‹¤í–‰ ëª…ë ¹
# =============================================================================
# Nginxë¥¼ í¬ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ (ì‹œê·¸ë„ ì²˜ë¦¬ìš©)
CMD ["nginx", "-g", "daemon off;"]

# =============================================================================
# ğŸ” í—¬ìŠ¤ì²´í¬ (ì¿ ë²„ë„¤í‹°ìŠ¤ ì—°ë™ìš©)
# =============================================================================
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:80/ || exit 1

# =============================================================================
# ğŸ“ ë©”íƒ€ë°ì´í„° ë° ì •ë³´
# =============================================================================
# ë²„ì „ ì •ë³´
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION

# ë¼ë²¨ ì •ë³´ (OCI ì´ë¯¸ì§€ ìŠ¤í™ ì¤€ìˆ˜)
LABEL org.opencontainers.image.title="Web3 Community Frontend" \
      org.opencontainers.image.description="Vue.js 3 frontend for Web3 Community platform" \
      org.opencontainers.image.url="https://github.com/your-org/web3-community" \
      org.opencontainers.image.source="https://github.com/your-org/web3-community" \
      org.opencontainers.image.version="${VERSION:-latest}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="Web3 Community Team" \
      org.opencontainers.image.licenses="MIT"

# =============================================================================
# ğŸ›¡ï¸ ë³´ì•ˆ ê°•í™”
# =============================================================================
# root ì‚¬ìš©ìë¡œ ì‹¤í–‰í•˜ì§€ ì•Šë„ë¡ ì„¤ì •
USER nginx

# =============================================================================
# ğŸ“ ë³¼ë¥¨ ì„¤ì • (ì„ íƒì‚¬í•­)
# =============================================================================
# ì •ì  íŒŒì¼ ì—…ë°ì´íŠ¸ìš© ë³¼ë¥¨ (í•„ìš”ì‹œ ì‚¬ìš©)
# VOLUME ["/usr/share/nginx/html"]

# =============================================================================
# ğŸš€ ê°œë°œ í™˜ê²½ìš© (ê°œë°œ ì‹œ ì‚¬ìš©)
# =============================================================================
# ê°œë°œ í™˜ê²½ìœ¼ë¡œ ë¹Œë“œ ì‹œ:
# docker build --target builder -t web3-community/frontend:dev .
# docker run -p 3000:3000 -v $(pwd):/app -v /app/node_modules web3-community/frontend:dev npm run serve