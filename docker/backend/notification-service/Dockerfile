# =============================================================================
# ğŸ³ Notification Service Dockerfile (Kafka ê¸°ë°˜)
# =============================================================================
# ì„¤ëª…: ì•Œë¦¼ ì²˜ë¦¬ë¥¼ ìœ„í•œ Spring Boot ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìµœì í™” ì´ë¯¸ì§€
# ëª©ì : Kafka ê¸°ë°˜ì˜ ì´ë²¤íŠ¸ ë“œë¦¬ë¸ ì•Œë¦¼ ì‹œìŠ¤í…œ
# íŠ¹ì§•: WebFlux ë¦¬ì•¡í‹°ë¸Œ, Kotlin, Kafka, ë¹„ë™ê¸° ì²˜ë¦¬
# ì‹¤ë¬´ íŒ: Kafka ì»¨ìŠˆë¨¸ ìµœì í™”, ì´ë²¤íŠ¸ ì²˜ë¦¬, ì‹¤íŒ¨ ì¬ì‹œë„
# =============================================================================

# =============================================================================
# ğŸ—ï¸ ë¹Œë“œ ìŠ¤í…Œì´ì§€ (Maven ë¹Œë“œ í™˜ê²½)
# =============================================================================
FROM maven:3.9-eclipse-temurin-17-alpine AS builder

# ë¹Œë“œ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=builder \
      service=notification-service \
      technology=spring-boot-webflux-kotlin-kafka

WORKDIR /app

COPY pom.xml .

RUN mvn dependency:go-offline -B

COPY src ./src

ARG MAVEN_OPTS=-Dmaven.repo.local=/root/.m2/repository
RUN mvn clean package -B -q -DskipTests

# =============================================================================
# ğŸš€ í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ (ì‹¤í–‰ í™˜ê²½)
# =============================================================================
FROM eclipse-temurin:17-jre-alpine AS production

# í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=production \
      service=notification-service \
      technology=spring-boot-webflux-kotlin-kafka

# =============================================================================
# ğŸ”§ JRE ìµœì í™” ë° ë³´ì•ˆ ì„¤ì •
# =============================================================================
RUN addgroup -g 1001 -S spring && \
    adduser -S spring -u 1001 -G spring

WORKDIR /app

# =============================================================================
# ğŸ“¦ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
# =============================================================================
COPY --from=builder /app/target/*.jar app.jar

RUN chown spring:spring app.jar && \
    chmod 500 app.jar

# =============================================================================
# âš™ï¸ JVM íŠœë‹ (Kafka ì—°ë™ ìµœì í™”)
# =============================================================================
ENV JAVA_OPTS="-server \
              -Xms256m \
              -Xmx512m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -XX:+UseContainerSupport \
              -XX:MaxRAMPercentage=75.0 \
              -Djava.security.egd=file:/dev/./urandom \
              -Dspring.profiles.active=kubernetes"

# Kafka ì—°ë™ ìµœì í™”
ENV SPRING_OPTS="--spring.jmx.enabled=false \
                 --management.endpoints.web.exposure.include=health,info,metrics,prometheus \
                 --management.endpoint.health.show-details=always \
                 --spring.kafka.bootstrap-servers=kafka-service:9092 \
                 --spring.kafka.consumer.group-id=notification-service \
                 --spring.kafka.consumer.auto-offset-reset=earliest \
                 --spring.kafka.consumer.enable-auto-commit=false \
                 --spring.kafka.listener.ack-mode=manual"

# =============================================================================
# ğŸŒ í¬íŠ¸ ì„¤ì •
# =============================================================================
EXPOSE 8085

# =============================================================================
# ğŸ¯ ì‹¤í–‰ ëª…ë ¹
# =============================================================================
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar $SPRING_OPTS"]

# =============================================================================
# ğŸ” í—¬ìŠ¤ì²´í¬
# =============================================================================
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8085/actuator/health || exit 1

# =============================================================================
# ğŸ“ ë©”íƒ€ë°ì´í„°
# =============================================================================
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION

LABEL org.opencontainers.image.title="Web3 Community Notification Service" \
      org.opencontainers.image.description="Event-driven notification service with Kafka" \
      org.opencontainers.image.url="https://github.com/your-org/web3-community" \
      org.opencontainers.image.source="https://github.com/your-org/web3-community" \
      org.opencontainers.image.version="${VERSION:-latest}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="Web3 Community Team" \
      org.opencontainers.image.licenses="MIT"

# =============================================================================
# ğŸ›¡ï¸ ë³´ì•ˆ ê°•í™”
# =============================================================================
USER spring