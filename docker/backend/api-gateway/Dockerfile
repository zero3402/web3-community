# =============================================================================
# ğŸ³ Backend Dockerfile (API Gateway - Spring Boot + WebFlux + Kotlin)
# =============================================================================
# ì„¤ëª…: Spring Cloud Gatewayë¥¼ ìœ„í•œ ìµœì í™”ëœ Docker ì´ë¯¸ì§€
# ëª©ì : ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì˜ API ê²Œì´íŠ¸ì›¨ì´ ì—­í• 
# íŠ¹ì§•: WebFlux ë¦¬ì•¡í‹°ë¸Œ í”„ë¡œê·¸ë˜ë°, Kotlin ì–¸ì–´, ê²½ëŸ‰í™” ì´ë¯¸ì§€
# ì‹¤ë¬´ íŒ: JAR ìµœì í™”, JVM íŠœë‹, ë‹¤ë‹¨ê³„ ë¹Œë“œ
# =============================================================================

# =============================================================================
# ğŸ—ï¸ ë¹Œë“œ ìŠ¤í…Œì´ì§€ (Maven ë¹Œë“œ í™˜ê²½)
# =============================================================================
# Maven JDK 17 (LTS) - Alpine ê¸°ë°˜ìœ¼ë¡œ í¬ê¸° ìµœì†Œí™”
FROM maven:3.9-eclipse-temurin-17-alpine AS builder

# ë¹Œë“œ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=builder \
      service=api-gateway \
      technology=spring-boot-webflux-kotlin

# =============================================================================
# ğŸ“¦ Maven ë¹Œë“œ í™˜ê²½ ì„¤ì •
# =============================================================================
# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# âš¡ ë¹Œë“œ ì†ë„ ìµœì í™”: ì˜ì¡´ì„± ì„¤ì • íŒŒì¼ ë¨¼ì € ë³µì‚¬
# ì´ë ‡ê²Œ í•˜ë©´ ì†ŒìŠ¤ ì½”ë“œ ë³€ê²½ ì‹œ ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ ë°©ì§€
COPY pom.xml .

# Maven ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ (ì˜¤í”„ë¼ì¸ ë¹Œë“œìš©)
RUN mvn dependency:go-offline -B

# ğŸ”§ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY src ./src

# =============================================================================
# ğŸ¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
# =============================================================================
# Maven ë¹Œë“œ ì˜µì…˜ ì„¤ì •
ARG MAVEN_OPTS=-Dmaven.repo.local=/root/.m2/repository

# Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
# -B: ë¹„ëŒ€í™”í˜• ëª¨ë“œ, -q: quiet ëª¨ë“œ, -DskipTests: í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° (ë¹ ë¥¸ ë¹Œë“œ)
RUN mvn clean package -B -q -DskipTests

# =============================================================================
# ğŸš€ í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ (ì‹¤í–‰ í™˜ê²½)
# =============================================================================
# ìµœì†Œí•œì˜ JRE ì´ë¯¸ì§€ (Alpine Linux)
FROM eclipse-temurin:17-jre-alpine AS production

# í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=production \
      service=api-gateway \
      technology=spring-boot-webflux-kotlin

# =============================================================================
# ğŸ”§ JRE ìµœì í™” ë° ë³´ì•ˆ ì„¤ì •
# =============================================================================
# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ì ìƒì„± (ë³´ì•ˆ: root ì‚¬ìš©ì ê¸ˆì§€)
RUN addgroup -g 1001 -S spring && \
    adduser -S spring -u 1001 -G spring

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
WORKDIR /app

# =============================================================================
# ğŸ“¦ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
# =============================================================================
# ë¹Œë“œëœ JAR íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/target/*.jar app.jar

# JAR íŒŒì¼ ì†Œìœ ì ë³€ê²½
RUN chown spring:spring app.jar && \
    chmod 500 app.jar

# =============================================================================
# âš™ï¸ JVM íŠœë‹ ì„¤ì • (Spring Boot + WebFlux ìµœì í™”)
# =============================================================================
# JVM ì˜µì…˜ (ë©”ëª¨ë¦¬, GC, ì„±ëŠ¥ ìµœì í™”)
ENV JAVA_OPTS="-server \
              -Xms256m \
              -Xmx512m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -XX:+UseContainerSupport \
              -XX:MaxRAMPercentage=75.0 \
              -Djava.security.egd=file:/dev/./urandom \
              -Dspring.profiles.active=kubernetes"

# Spring Boot íŠ¹í™” ì„¤ì •
ENV SPRING_OPTS="--spring.jmx.enabled=false \
                 --management.endpoints.web.exposure.include=health,info,metrics,prometheus \
                 --management.endpoint.health.show-details=always"

# =============================================================================
# ğŸŒ í¬íŠ¸ ë° ë„¤íŠ¸ì›Œí¬ ì„¤ì •
# =============================================================================
# Spring Boot ê¸°ë³¸ í¬íŠ¸ (ì¬ì •ì˜ ê°€ëŠ¥)
EXPOSE 8080

# Spring Actuator í¬íŠ¸ (ëª¨ë‹ˆí„°ë§ìš©)
EXPOSE 8081

# =============================================================================
# ğŸ¯ ì‹¤í–‰ ëª…ë ¹ (ìµœì í™”ëœ Java ì‹¤í–‰)
# =============================================================================
# ìµœì í™”ëœ java ëª…ë ¹ìœ¼ë¡œ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar $SPRING_OPTS"]

# =============================================================================
# ğŸ” í—¬ìŠ¤ì²´í¬ (ì¿ ë²„ë„¤í‹°ìŠ¤ ì—°ë™ìš©)
# =============================================================================
# Spring Boot Actuator í—¬ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

# =============================================================================
# ğŸ“ ë©”íƒ€ë°ì´í„° ë° ì •ë³´
# =============================================================================
# ë¹Œë“œ ì •ë³´ (ë¹Œë“œ ì‹œì  ì „ë‹¬)
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION

# OCI ì´ë¯¸ì§€ ìŠ¤í™ ì¤€ìˆ˜ ë¼ë²¨
LABEL org.opencontainers.image.title="Web3 Community API Gateway" \
      org.opencontainers.image.description="Spring Cloud Gateway with WebFlux and Kotlin" \
      org.opencontainers.image.url="https://github.com/your-org/web3-community" \
      org.opencontainers.image.source="https://github.com/your-org/web3-community" \
      org.opencontainers.image.version="${VERSION:-latest}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="Web3 Community Team" \
      org.opencontainers.image.licenses="MIT"

# =============================================================================
# ğŸ›¡ï¸ ë³´ì•ˆ ê°•í™”
# =============================================================================
# spring ì‚¬ìš©ìë¡œ ì‹¤í–‰
USER spring

# =============================================================================
# ğŸ“ ë³¼ë¥¨ ì„¤ì • (ì„ íƒì‚¬í•­)
# =============================================================================
# ë¡œê·¸ íŒŒì¼ìš© ë³¼ë¥¨ (í•„ìš”ì‹œ)
# VOLUME ["/app/logs"]

# ì„¤ì • íŒŒì¼ìš© ë³¼ë¥¨ (ì™¸ë¶€ ì„¤ì • ë§ˆìš´íŠ¸ìš©)
# VOLUME ["/app/config"]

# =============================================================================
# ğŸš€ ê°œë°œ/ë””ë²„ê·¸ìš© (ê°œë°œ ì‹œ ì‚¬ìš©)
# =============================================================================
# ê°œë°œ í™˜ê²½ìœ¼ë¡œ ë¹Œë“œ ì‹œ:
# docker build --target builder -t web3-community/api-gateway:dev .
# docker run -p 8080:8080 -p 5005:5005 web3-community/api-gateway:dev mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005"

# ğŸ¯ ê¸°ë³¸ JVM ë””ë²„ê·¸ í¬íŠ¸ ì„¤ì • (ê°œë°œìš©)
# EXPOSE 5005