# =============================================================================
# ğŸ³ Backend Dockerfile (User Service - Spring Boot + WebFlux + Kotlin)
# =============================================================================
# ì„¤ëª…: ì‚¬ìš©ì ê´€ë¦¬ë¥¼ ìœ„í•œ Spring Boot ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìµœì í™” ì´ë¯¸ì§€
# ëª©ì : MySQL ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ë™ëœ ì‚¬ìš©ì CRUD ê¸°ëŠ¥ ì œê³µ
# íŠ¹ì§•: WebFlux ë¦¬ì•¡í‹°ë¸Œ, Kotlin, MySQL ì—°ê²°, JPA/ reactive ë¦¬í¬ì§€í† ë¦¬
# ì‹¤ë¬´ íŒ: ë°ì´í„°ë² ì´ìŠ¤ ì»¤ë„¥ì…˜ í’€, íŠ¸ëœì­ì…˜ ê´€ë¦¬, ë³´ì•ˆ ê°•í™”
# =============================================================================

# =============================================================================
# ğŸ—ï¸ ë¹Œë“œ ìŠ¤í…Œì´ì§€ (Maven ë¹Œë“œ í™˜ê²½)
# =============================================================================
FROM maven:3.9-eclipse-temurin-17-alpine AS builder

# ë¹Œë“œ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=builder \
      service=user-service \
      technology=spring-boot-webflux-kotlin-mysql

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# âš¡ ë¹Œë“œ ì†ë„ ìµœì í™”: ì˜ì¡´ì„± ë¨¼ì € ë³µì‚¬í•˜ì—¬ ìºì‹œ í™œìš©
COPY pom.xml .

# Maven ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ (ì˜¤í”„ë¼ì¸ ë¹Œë“œ ì¤€ë¹„)
RUN mvn dependency:go-offline -B

# ğŸ”§ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY src ./src

# =============================================================================
# ğŸ¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
# =============================================================================
# Maven ë¹Œë“œ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ëŠ” ë‚˜ì¤‘ì— í†µí•© í…ŒìŠ¤íŠ¸ì—ì„œ)
ARG MAVEN_OPTS=-Dmaven.repo.local=/root/.m2/repository
RUN mvn clean package -B -q -DskipTests

# =============================================================================
# ğŸš€ í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ (ì‹¤í–‰ í™˜ê²½)
# =============================================================================
FROM eclipse-temurin:17-jre-alpine AS production

# í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=production \
      service=user-service \
      technology=spring-boot-webflux-kotlin-mysql

# =============================================================================
# ğŸ”§ JRE ìµœì í™” ë° ë³´ì•ˆ ì„¤ì •
# =============================================================================
# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ì ìƒì„±
RUN addgroup -g 1001 -S spring && \
    adduser -S spring -u 1001 -G spring

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ìƒì„±
WORKDIR /app

# =============================================================================
# ğŸ“¦ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
# =============================================================================
# ë¹Œë“œëœ JAR íŒŒì¼ ë³µì‚¬
COPY --from=builder /app/target/*.jar app.jar

# ì†Œìœ ê¶Œ ë° ê¶Œí•œ ì„¤ì •
RUN chown spring:spring app.jar && \
    chmod 500 app.jar

# =============================================================================
# âš™ï¸ JVM íŠœë‹ (ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ìµœì í™”)
# =============================================================================
ENV JAVA_OPTS="-server \
              -Xms256m \
              -Xmx768m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -XX:+UseContainerSupport \
              -XX:MaxRAMPercentage=75.0 \
              -Djava.security.egd=file:/dev/./urandom \
              -Dspring.profiles.active=kubernetes"

# Spring Boot ë°ì´í„°ë² ì´ìŠ¤ ìµœì í™” ì„¤ì •
ENV SPRING_OPTS="--spring.jmx.enabled=false \
                 --management.endpoints.web.exposure.include=health,info,metrics,prometheus \
                 --management.endpoint.health.show-details=always \
                 --spring.datasource.hikari.maximum-pool-size=20 \
                 --spring.datasource.hikari.minimum-idle=5 \
                 --spring.datasource.hikari.idle-timeout=300000 \
                 --spring.datasource.hikari.pool-name=UserServiceHikariCP"

# =============================================================================
# ğŸŒ í¬íŠ¸ ì„¤ì •
# =============================================================================
# ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸
EXPOSE 8081

# ì•¡ì¶”ì—ì´í„° í¬íŠ¸ (ë¶„ë¦¬ ìš´ì˜)
EXPOSE 8082

# =============================================================================
# ğŸ¯ ì‹¤í–‰ ëª…ë ¹
# =============================================================================
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar $SPRING_OPTS"]

# =============================================================================
# ğŸ” í—¬ìŠ¤ì²´í¬ (ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸)
# =============================================================================
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8081/actuator/health || exit 1

# =============================================================================
# ğŸ“ ë©”íƒ€ë°ì´í„°
# =============================================================================
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION

LABEL org.opencontainers.image.title="Web3 Community User Service" \
      org.opencontainers.image.description="User management service with MySQL database" \
      org.opencontainers.image.url="https://github.com/your-org/web3-community" \
      org.opencontainers.image.source="https://github.com/your-org/web3-community" \
      org.opencontainers.image.version="${VERSION:-latest}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="Web3 Community Team" \
      org.opencontainers.image.licenses="MIT"

# =============================================================================
# ğŸ›¡ï¸ ë³´ì•ˆ ê°•í™”
# =============================================================================
USER spring

# =============================================================================
# ğŸ“ ë³¼ë¥¨ ì„¤ì •
# =============================================================================
# ë¡œê·¸ ë³¼ë¥¨
# VOLUME ["/app/logs"]

# ì„¤ì • íŒŒì¼ ë³¼ë¥¨
# VOLUME ["/app/config"]

# =============================================================================
# ğŸš€ ê°œë°œ í™˜ê²½ ì„¤ì •
# =============================================================================
# ê°œë°œ ë¹Œë“œ: docker build --target builder -t web3-community/user-service:dev .
# ê°œë°œ ì‹¤í–‰: docker run -p 8081:8081 -p 5006:5006 web3-community/user-service:dev mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5006"

# ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ìš© í¬íŠ¸
# EXPOSE 5006