# =============================================================================
# ğŸ³ Auth Service Dockerfile (Redis ê¸°ë°˜)
# =============================================================================
# ì„¤ëª…: ì¸ì¦/ì¸ê°€ë¥¼ ìœ„í•œ Spring Boot ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìµœì í™” ì´ë¯¸ì§€
# ëª©ì : Redis ê¸°ë°˜ì˜ JWT í† í° ê´€ë¦¬, ì„¸ì…˜ ê´€ë¦¬ ê¸°ëŠ¥ ì œê³µ
# íŠ¹ì§•: WebFlux ë¦¬ì•¡í‹°ë¸Œ, Kotlin, Redis, ë³´ì•ˆ ê°•í™”
# ì‹¤ë¬´ íŒ: JWT ìµœì í™”, ì„¸ì…˜ ê´€ë¦¬, ë³´ì•ˆ ì„¤ì •, OAuth2 ì—°ë™
# =============================================================================

# =============================================================================
# ğŸ—ï¸ ë¹Œë“œ ìŠ¤í…Œì´ì§€ (Maven ë¹Œë“œ í™˜ê²½)
# =============================================================================
FROM maven:3.9-eclipse-temurin-17-alpine AS builder

# ë¹Œë“œ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=builder \
      service=auth-service \
      technology=spring-boot-webflux-kotlin-redis

WORKDIR /app

COPY pom.xml .

RUN mvn dependency:go-offline -B

COPY src ./src

ARG MAVEN_OPTS=-Dmaven.repo.local=/root/.m2/repository
RUN mvn clean package -B -q -DskipTests

# =============================================================================
# ğŸš€ í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ (ì‹¤í–‰ í™˜ê²½)
# =============================================================================
FROM eclipse-temurin:17-jre-alpine AS production

# í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=production \
      service=auth-service \
      technology=spring-boot-webflux-kotlin-redis

# =============================================================================
# ğŸ”§ JRE ìµœì í™” ë° ë³´ì•ˆ ì„¤ì •
# =============================================================================
RUN addgroup -g 1001 -S spring && \
    adduser -S spring -u 1001 -G spring

WORKDIR /app

# =============================================================================
# ğŸ“¦ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
# =============================================================================
COPY --from=builder /app/target/*.jar app.jar

RUN chown spring:spring app.jar && \
    chmod 500 app.jar

# =============================================================================
# âš™ï¸ JVM íŠœë‹ (Redis ì—°ë™ ìµœì í™”)
# =============================================================================
ENV JAVA_OPTS="-server \
              -Xms128m \
              -Xmx256m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -XX:+UseContainerSupport \
              -XX:MaxRAMPercentage=75.0 \
              -Djava.security.egd=file:/dev/./urandom \
              -Dspring.profiles.active=kubernetes"

# Redis ë° JWT ìµœì í™”
ENV SPRING_OPTS="--spring.jmx.enabled=false \
                 --management.endpoints.web.exposure.include=health,info,metrics,prometheus \
                 --management.endpoint.health.show-details=always \
                 --spring.data.redis.host=redis-service \
                 --spring.data.redis.port=6379 \
                 --spring.data.redis.password=redispass \
                 --spring.data.redis.database=0 \
                 --spring.session.store-type=redis"

# JWT ì„¤ì • í™˜ê²½ ë³€ìˆ˜
ENV JWT_SECRET="mysecretjwdkey123"
ENV JWT_EXPIRATION="86400"

# =============================================================================
# ğŸŒ í¬íŠ¸ ì„¤ì •
# =============================================================================
EXPOSE 8084

# =============================================================================
# ğŸ¯ ì‹¤í–‰ ëª…ë ¹
# =============================================================================
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar $SPRING_OPTS"]

# =============================================================================
# ğŸ” í—¬ìŠ¤ì²´í¬
# =============================================================================
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8084/actuator/health || exit 1

# =============================================================================
# ğŸ“ ë©”íƒ€ë°ì´í„°
# =============================================================================
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION

LABEL org.opencontainers.image.title="Web3 Community Auth Service" \
      org.opencontainers.image.description="Authentication service with Redis session management" \
      org.opencontainers.image.url="https://github.com/your-org/web3-community" \
      org.opencontainers.image.source="https://github.com/your-org/web3-community" \
      org.opencontainers.image.version="${VERSION:-latest}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="Web3 Community Team" \
      org.opencontainers.image.licenses="MIT"

# =============================================================================
# ğŸ›¡ï¸ ë³´ì•ˆ ê°•í™”
# =============================================================================
USER spring