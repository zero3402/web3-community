# =============================================================================
# ğŸ³ Post Service Dockerfile (MongoDB ê¸°ë°˜)
# =============================================================================
# ì„¤ëª…: ê²Œì‹œê¸€ ê´€ë¦¬ë¥¼ ìœ„í•œ Spring Boot ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ìµœì í™” ì´ë¯¸ì§€
# ëª©ì : MongoDBì™€ ì—°ë™ëœ ê²Œì‹œê¸€ CRUD, ê²€ìƒ‰ ê¸°ëŠ¥ ì œê³µ
# íŠ¹ì§•: WebFlux ë¦¬ì•¡í‹°ë¸Œ, Kotlin, MongoDB, ì „ë¬¸ ê²€ìƒ‰
# ì‹¤ë¬´ íŒ: MongoDB ì¸ë±ìŠ¤ ìµœì í™”, í˜ì´ì§• ì²˜ë¦¬, ê²€ìƒ‰ ì„±ëŠ¥
# =============================================================================

# =============================================================================
# ğŸ—ï¸ ë¹Œë“œ ìŠ¤í…Œì´ì§€ (Maven ë¹Œë“œ í™˜ê²½)
# =============================================================================
FROM maven:3.9-eclipse-temurin-17-alpine AS builder

# ë¹Œë“œ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=builder \
      service=post-service \
      technology=spring-boot-webflux-kotlin-mongodb

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì˜ì¡´ì„± ìµœì í™”: pom.xml ë¨¼ì € ë³µì‚¬
COPY pom.xml .

# Maven ì˜ì¡´ì„± ë‹¤ìš´ë¡œë“œ
RUN mvn dependency:go-offline -B

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY src ./src

# ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
ARG MAVEN_OPTS=-Dmaven.repo.local=/root/.m2/repository
RUN mvn clean package -B -q -DskipTests

# =============================================================================
# ğŸš€ í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ (ì‹¤í–‰ í™˜ê²½)
# =============================================================================
FROM eclipse-temurin:17-jre-alpine AS production

# í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€ ë¼ë²¨
LABEL stage=production \
      service=post-service \
      technology=spring-boot-webflux-kotlin-mongodb

# =============================================================================
# ğŸ”§ JRE ìµœì í™” ë° ë³´ì•ˆ ì„¤ì •
# =============================================================================
RUN addgroup -g 1001 -S spring && \
    adduser -S spring -u 1001 -G spring

WORKDIR /app

# =============================================================================
# ğŸ“¦ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
# =============================================================================
COPY --from=builder /app/target/*.jar app.jar

RUN chown spring:spring app.jar && \
    chmod 500 app.jar

# =============================================================================
# âš™ï¸ JVM íŠœë‹ (MongoDB ì—°ë™ ìµœì í™”)
# =============================================================================
ENV JAVA_OPTS="-server \
              -Xms256m \
              -Xmx512m \
              -XX:+UseG1GC \
              -XX:MaxGCPauseMillis=200 \
              -XX:+UseContainerSupport \
              -XX:MaxRAMPercentage=75.0 \
              -Djava.security.egd=file:/dev/./urandom \
              -Dspring.profiles.active=kubernetes"

# MongoDB ì—°ë™ ìµœì í™”
ENV SPRING_OPTS="--spring.jmx.enabled=false \
                 --management.endpoints.web.exposure.include=health,info,metrics,prometheus \
                 --management.endpoint.health.show-details=always \
                 --spring.data.mongodb.uri=mongodb://mongouser:mongopass@mongodb-service:27017/web3_posts \
                 --spring.data.mongodb.auto-index-creation=true"

# =============================================================================
# ğŸŒ í¬íŠ¸ ì„¤ì •
# =============================================================================
EXPOSE 8082

# =============================================================================
# ğŸ¯ ì‹¤í–‰ ëª…ë ¹
# =============================================================================
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/app.jar $SPRING_OPTS"]

# =============================================================================
# ğŸ” í—¬ìŠ¤ì²´í¬
# =============================================================================
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8082/actuator/health || exit 1

# =============================================================================
# ğŸ“ ë©”íƒ€ë°ì´í„°
# =============================================================================
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION

LABEL org.opencontainers.image.title="Web3 Community Post Service" \
      org.opencontainers.image.description="Post management service with MongoDB database" \
      org.opencontainers.image.url="https://github.com/your-org/web3-community" \
      org.opencontainers.image.source="https://github.com/your-org/web3-community" \
      org.opencontainers.image.version="${VERSION:-latest}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="Web3 Community Team" \
      org.opencontainers.image.licenses="MIT"

# =============================================================================
# ğŸ›¡ï¸ ë³´ì•ˆ ê°•í™”
# =============================================================================
USER spring