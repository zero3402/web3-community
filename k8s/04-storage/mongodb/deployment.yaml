# =============================================================================
# ğŸƒ MongoDB ë°ì´í„°ë² ì´ìŠ¤ ë°°í¬
# =============================================================================
# ğŸ“ ì„¤ëª…: ê²Œì‹œê¸€/ëŒ“ê¸€ ê´€ë¦¬ë¥¼ ìœ„í•œ MongoDB 6.0 ë¬¸ì„œ ë°ì´í„°ë² ì´ìŠ¤ ë°°í¬
# ğŸ¯ ëª©ì : ìœ ì—°í•œ ìŠ¤í‚¤ë§ˆ, JSON ë¬¸ì„œ ì €ì¥, ë³µì œì…‹ ì§€ì›
# ğŸŒŸ ì‹¤ë¬´ íŒ: ë¡œì»¬ ê°œë°œìš© Deployment (ìš´ì˜ì€ StatefulSet + ë³µì œì…‹ ì¶”ì²œ)
# âš ï¸  ì£¼ì˜: ìš´ì˜ í™˜ê²½ì—ì„œëŠ” StatefulSet + ë³µì œì…‹ + Backup ì „ëµ ì‚¬ìš©
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #4-2-4 (PVC, Service ìƒì„± í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://kubernetes.io/docs/concepts/workloads/controllers/deployment/
# =============================================================================

apiVersion: apps/v1
kind: Deployment

metadata:
  name: mongodb-deployment        # ë°°í¬ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ìŠ¤
  
  labels:
    app: web3-community
    component: database
    database: mongodb
    tier: data
    environment: local
    deployment-type: database
  
  annotations:
    description: "MongoDB 6.0 database deployment for posts and comments"
    created-by: "developer"
    deployment-version: "v1.0"
    kubernetes.io/rollout-version: "v1.0"

spec:
  replicas: 1                      # ë¡œì»¬ ê°œë°œìš© 1ê°œ ë³µì œë³¸
  
  selector:
    matchLabels:
      app: mongodb
      component: database
      tier: data
  
  template:
    metadata:
      labels:
        app: mongodb
        component: database
        tier: data
        environment: local
        pod-template-hash: "auto-generated"
      
      annotations:
        description: "MongoDB database pod"
        created-by: "developer"
        restart-policy: "Always"
    
    spec:
      # =============================================================================
      # ğŸ¥ ì»¨í…Œì´ë„ˆ ì„¤ì •
      # =============================================================================
      containers:
      - name: mongodb
        image: mongo:6.0            # MongoDB 6.0 ë²„ì „
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: mongodb
          containerPort: 27017
          protocol: TCP
        
        env:
        # MongoDB ê´€ë¦¬ì ê³„ì • (Secretì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        - name: MONGO_INITDB_ROOT_USERNAME
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: mongodb-root-username
        
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: mongodb-root-password
        
        # ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì •
        - name: MONGO_INITDB_USERNAME
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: mongodb-username
        
        - name: MONGO_INITDB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: mongodb-password
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
        - name: MONGO_INITDB_DATABASE
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: mongodb-database-name
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          exec:
            command:
            - mongosh
            - --eval
            - "db.adminCommand('ping')"
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          exec:
            command:
            - mongosh
            - --eval
            - "db.adminCommand('ping')"
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "512Mi"           # MongoDBëŠ” ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ë§ìŒ
            cpu: "250m"
          limits:
            memory: "1Gi"             # ì¶©ë¶„í•œ ë©”ëª¨ë¦¬ í• ë‹¹
            cpu: "500m"
        
        # =============================================================================
        # ğŸ“ ë³¼ë¥¨ ë§ˆìš´íŠ¸
        # =============================================================================
        volumeMounts:
        - name: mongodb-data-volume
          mountPath: /data/db         # MongoDB ê¸°ë³¸ ë°ì´í„° ê²½ë¡œ
          subPath: mongodb
        
        - name: mongodb-init-volume
          mountPath: /docker-entrypoint-initdb.d
          readOnly: true
        
        # =============================================================================
        # ğŸ”§ ëª…ë ¹ì–´ ë° ì¸ì (MongoDB ìµœì í™”)
        # =============================================================================
        command:
        - mongod
        - --bind_ip_all               # ëª¨ë“  IPì—ì„œ ì ‘ì† í—ˆìš©
        - --auth                      # ì¸ì¦ í™œì„±í™”
        - --replSet                   # ë³µì œì…‹ ì´ë¦„ (Headless Serviceìš©)
        - --storageEngine              # ìŠ¤í† ë¦¬ì§€ ì—”ì§„ ëª…ì‹œ
        - wiredTiger
        - --wiredTigerCacheSizeGB      # ìºì‹œ í¬ê¸° ì„¤ì •
        - "0.5"
        - --journalCommitIntervalMs   # ì €ë„ ì»¤ë°‹ ê°„ê²© (ì„±ëŠ¥ ìµœì í™”)
        - "100"
        
        args:
        - "rs0"                       # ë³µì œì…‹ ì´ë¦„
      
      # =============================================================================
      # ğŸ“¦ Init Container: MongoDB ì´ˆê¸°í™”
      # =============================================================================
      initContainers:
      - name: mongodb-init
        image: mongo:6.0
        command: ['sh', '-c']
        args:
          - |
            # MongoDBê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            until mongosh --host localhost:27017 --eval "db.adminCommand('ismaster')" ; do
              echo "Waiting for MongoDB to start..."
              sleep 2
            done
            
            echo "MongoDB is ready. Initializing database..."
            mongosh --host localhost:27017 <<EOF
            use admin
            db.createUser({
              user: "$MONGO_INITDB_USERNAME",
              pwd: "$MONGO_INITDB_PASSWORD",
              roles: [
                {
                  role: "readWrite",
                  db: "$MONGO_INITDB_DATABASE"
                }
              ]
            })
            
            use $MONGO_INITDB_DATABASE
            db.createCollection("init_test")
            db.init_test.insertOne({message: "MongoDB initialized successfully"})
            print("MongoDB initialization completed successfully!")
EOF
        envFrom:
        - secretRef:
            name: database-secrets
        - configMapRef:
            name: database-config
      
      # =============================================================================
      # ğŸ“¦ ë³¼ë¥¨ ì •ì˜
      # =============================================================================
      volumes:
      - name: mongodb-data-volume
        persistentVolumeClaim:
          claimName: mongodb-pvc
      
      - name: mongodb-init-volume
        configMap:
          name: database-config
          optional: true

# =============================================================================
# ğŸŒŸ MongoDB ê´€ë¦¬ ëª…ë ¹ì–´
# =============================================================================
# 
# ë°°í¬ ìƒíƒœ í™•ì¸:
# kubectl get deployment mongodb-deployment -n web3-community
# kubectl get pods -l app=mongodb -n web3-community
# kubectl describe deployment mongodb-deployment -n web3-community
#
# MongoDB ì ‘ì†:
# kubectl exec -it deployment/mongodb-deployment -n web3-community -- mongosh
#
# ë³µì œì…‹ ìƒíƒœ í™•ì¸ (ë³µì œì…‹ êµ¬ì„± ì‹œ):
# kubectl exec -it deployment/mongodb-deployment -n web3-community -- \
#   mongosh --eval "rs.status()"
#
# ë³µì œì…‹ ì´ˆê¸°í™” (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ì—ì„œë„ ê°€ëŠ¥):
# kubectl exec -it deployment/mongodb-deployment -n web3-community -- \
#   mongosh --eval "rs.initiate({_id: 'rs0', members: [{_id: 0, host: 'mongodb-0.mongodb-headless:27017'}])"
#
# ë°±ì—…:
# kubectl exec deployment/mongodb-deployment -n web3-community -- \
#   mongodump --db web3_posts --out /tmp/backup
# kubectl cp deployment/mongodb-deployment:/tmp/backup ./mongodb-backup
#
# ë³µì›:
# kubectl cp ./mongodb-backup deployment/mongodb-deployment:/tmp/restore
# kubectl exec deployment/mongodb-deployment -n web3-community -- \
#   mongorestore --db web3_posts /tmp/restore/web3_posts
#
# ëª¨ë‹ˆí„°ë§:
# kubectl exec deployment/mongodb-deployment -n web3-community -- \
#   mongosh --eval "db.stats()"
# kubectl exec deployment/mongodb-deployment -n web3-community -- \
#   mongosh --eval "db.serverStatus()"
#
# ì‹¤ë¬´ íŒ:
# - ìš´ì˜ í™˜ê²½ì—ì„œëŠ” StatefulSet + ë³µì œì…‹ (3ê°œ ì´ìƒ) êµ¬ì„±
# - ì •ê¸°ì ì¸ ë°±ì—… ë° ë³µì› í…ŒìŠ¤íŠ¸ í•„ìˆ˜
# - ì¸ë±ìŠ¤ ìµœì í™”ë¡œ ì¿¼ë¦¬ ì„±ëŠ¥ í–¥ìƒ
# - ì¿¼ë¦¬ í”„ë¡œíŒŒì¼ë§ìœ¼ë¡œ ë³‘ëª© ì§€ì  ì‹ë³„
# - ìŠ¤í† ë¦¬ì§€ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (IOPS, latency)
# =============================================================================