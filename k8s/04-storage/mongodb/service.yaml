# =============================================================================
# ğŸƒ MongoDB ì„œë¹„ìŠ¤ ì •ì˜
# =============================================================================
# ğŸ“ ì„¤ëª…: MongoDB ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì†ì„ ìœ„í•œ ë„¤íŠ¸ì›Œí¬ ì„œë¹„ìŠ¤ ì •ì˜
# ğŸ¯ ëª©ì : ì•ˆì •ì ì¸ MongoDB ì ‘ì† ì—”ë“œí¬ì¸íŠ¸ ì œê³µ, ë³µì œì…‹ í†µì‹ 
# ğŸŒŸ ì‹¤ë¬´ íŒ: ë³µì œì…‹ êµ¬ì„± ì‹œ Headless Service ì¶”ê°€ ê¶Œì¥
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #4-2-2 (PVC ìƒì„± í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://kubernetes.io/docs/concepts/services-networking/service/
# =============================================================================

apiVersion: v1
kind: Service

metadata:
  name: mongodb-service           # ì„œë¹„ìŠ¤ ì´ë¦„ (DNS ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©ë¨)
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ìŠ¤
  
  labels:
    app: web3-community
    component: database
    database: mongodb
    tier: data
    service-type: database
    environment: local
  
  annotations:
    description: "MongoDB database service endpoint"
    created-by: "developer"
    # MongoDB ë“œë¼ì´ë²„ ìµœì í™”
    prometheus.io/scrape: "false"

spec:
  # =============================================================================
  # ğŸŒ ì„œë¹„ìŠ¤ íƒ€ì…
  # =============================================================================
  # ClusterIP: í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ (ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ)
  type: ClusterIP
  
  # =============================================================================
  # ğŸ¯ ì…€ë ‰í„°: ì–´ë–¤ Podë¥¼ ì—°ê²°í• ì§€ ì§€ì •
  # =============================================================================
  # mongodb-deployment.yamlì˜ labelsê³¼ ì¼ì¹˜í•´ì•¼ í•¨
  selector:
    app: mongodb
    component: database
    tier: data
  
  # =============================================================================
  # ğŸ“¡ í¬íŠ¸ ì„¤ì •
  # =============================================================================
  ports:
    - name: mongodb              # í¬íŠ¸ ì´ë¦„
      protocol: TCP             # í”„ë¡œí† ì½œ íƒ€ì…
      port: 27017              # ì„œë¹„ìŠ¤ í¬íŠ¸ (í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ì ‘ì†)
      targetPort: 27017        # ì»¨í…Œì´ë„ˆ ì‹¤ì œ í¬íŠ¸

---
# =============================================================================
# ğŸŒ MongoDB Headless Service (ë³µì œì…‹ìš©)
# =============================================================================
# ğŸ“ ì„¤ëª…: MongoDB ë³µì œì…‹ êµ¬ì„±ì„ ìœ„í•œ Headless Service
# ğŸ¯ ëª©ì : ê° MongoDB Podì— ì§ì ‘ ì ‘ì†í•˜ê¸° ìœ„í•œ DNS ë ˆì½”ë“œ ì œê³µ
# ğŸŒŸ ì‹¤ë¬´ íŒ: ë³µì œì…‹, í´ëŸ¬ìŠ¤í„°ë§ êµ¬ì„± ì‹œ í•„ìˆ˜ì ìœ¼ë¡œ í•„ìš”
# âš ï¸  ì£¼ì˜: ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ í™˜ê²½ì—ì„œëŠ” ì„ íƒì‚¬í•­
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #4-2-3 (ì¼ë°˜ Serviceì™€ í•¨ê»˜ ì‹¤í–‰)
# =============================================================================

apiVersion: v1
kind: Service

metadata:
  name: mongodb-headless         # Headless Service ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ìŠ¤
  
  labels:
    app: web3-community
    component: database
    database: mongodb
    tier: data
    service-type: headless
    environment: local
  
  annotations:
    description: "Headless service for MongoDB replica set"
    created-by: "developer"
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"

spec:
  # =============================================================================
  # ğŸŒ Headless Service ì„¤ì •
  # =============================================================================
  # ClusterIP: Noneìœ¼ë¡œ ì„¤ì •í•˜ì—¬ Headless Service ìƒì„±
  # ê° Podì— ëŒ€í•œ DNS ë ˆì½”ë“œ ìƒì„± (pod-name.mongodb-headless.namespace.svc.cluster.local)
  clusterIP: None
  
  # =============================================================================
  # ğŸ¯ ì…€ë ‰í„°
  # =============================================================================
  selector:
    app: mongodb
    component: database
    tier: data
  
  # =============================================================================
  # ğŸ“¡ í¬íŠ¸ ì„¤ì •
  # =============================================================================
  ports:
    - name: mongodb
      protocol: TCP
      port: 27017
      targetPort: 27017

# =============================================================================
# ğŸŒŸ ì„œë¹„ìŠ¤ ì ‘ì† ë°©ë²•
# =============================================================================
# 
# ì¼ë°˜ Service ì ‘ì† (ë¡œë“œë°¸ëŸ°ì‹±):
# - Hostname: mongodb-service.web3-community.svc.cluster.local
# - Port: 27017
# - ê°„ë‹¨íˆ: mongodb-service (ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
#
# Headless Service ì ‘ì† (ì§ì ‘ Pod ì ‘ì†):
# - Pod1: mongodb-0.mongodb-headless.web3-community.svc.cluster.local
# - Pod2: mongodb-1.mongodb-headless.web3-community.svc.cluster.local
# - Spring Boot MongoDB URI ì˜ˆì‹œ:
#   mongodb://mongouser:mongopass@mongodb-0.mongodb-headless:27017,mongodb-1.mongodb-headless:27017/web3_posts?replicaSet=rs0
#
# Spring Boot application.yml ì„¤ì • ì˜ˆì‹œ:
# spring:
#   data:
#     mongodb:
#       uri: mongodb://mongouser:mongopass@mongodb-service:27017/web3_posts
#       database: web3_posts
#       auto-index-creation: true
#
# ì ‘ì† í…ŒìŠ¤íŠ¸:
# kubectl run mongodb-client --image=mongo:6.0 --rm -it --restart=Never \
#   -- mongosh mongodb-service:27017/web3_posts -u mongouser -p
#
# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:
# kubectl get svc mongodb-service mongodb-headless -n web3-community
# kubectl describe svc mongodb-service -n web3-community
# kubectl get endpoints mongodb-service -n web3-community
#
# Headless Service DNS í™•ì¸:
# kubectl run dns-test --image=busybox --rm -it --restart=Never \
#   -- nslookup mongodb-headless.web3-community
#
# ë³µì œì…‹ ìƒíƒœ í™•ì¸:
# kubectl exec -it deployment/mongodb-deployment -n web3-community -- \
#   mongosh --eval "rs.status()"
#
# ì‹¤ë¬´ íŒ:
# - ë³µì œì…‹ êµ¬ì„± ì‹œ Headless Service í•„ìˆ˜
# - ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ ì‹œ ì¼ë°˜ Serviceì™€ Headless Service ëª¨ë‘ í•„ìš”
# - ë³µì œì…‹ í”„ë¼ì´ë¨¸ë¦¬ ì„ ê±°ë¥¼ ìœ„í•œ ì•ˆì •ì ì¸ ë„¤íŠ¸ì›Œí¬ ì—°ê²°
# - ìš´ì˜ í™˜ê²½ì—ì„œëŠ” 3ê°œ ì´ìƒì˜ odd numberë¡œ ë³µì œì…‹ êµ¬ì„±
# =============================================================================