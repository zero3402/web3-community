# =============================================================================
# ğŸ”´ Redis ë°ì´í„°ë² ì´ìŠ¤ ë°°í¬
# =============================================================================
# ğŸ“ ì„¤ëª…: ìºì‹œ/ì„¸ì…˜ ê´€ë¦¬ë¥¼ ìœ„í•œ Redis 7.0 ì¸ë©”ëª¨ë¦¬ ë°ì´í„°ë² ì´ìŠ¤ ë°°í¬
# ğŸ¯ ëª©ì : ë¹ ë¥¸ ë°ì´í„° ì ‘ê·¼, ì„¸ì…˜ ê´€ë¦¬, ìºì‹±, Pub/Sub ê¸°ëŠ¥ ì œê³µ
# ğŸŒŸ ì‹¤ë¬´ íŒ: ë©”ëª¨ë¦¬ ê´€ë¦¬ì™€ ì§€ì†ì„± ì„¤ì •ì´ ì¤‘ìš”
# âš ï¸  ì£¼ì˜: ìš´ì˜ í™˜ê²½ì—ì„œëŠ” Cluster Mode + Sentinel ê³ ë ¤
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #4-3-3 (PVC, Service ìƒì„± í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://kubernetes.io/docs/concepts/workloads/controllers/deployment/
# =============================================================================

apiVersion: apps/v1
kind: Deployment

metadata:
  name: redis-deployment          # ë°°í¬ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ìŠ¤
  
  labels:
    app: web3-community
    component: database
    database: redis
    tier: data
    environment: local
    deployment-type: database
  
  annotations:
    description: "Redis 7.0 deployment for caching and session management"
    created-by: "developer"
    deployment-version: "v1.0"

spec:
  replicas: 1                      # ë¡œì»¬ ê°œë°œìš© 1ê°œ ë³µì œë³¸
  
  selector:
    matchLabels:
      app: redis
      component: database
      tier: data
  
  template:
    metadata:
      labels:
        app: redis
        component: database
        tier: data
        environment: local
        pod-template-hash: "auto-generated"
      
      annotations:
        description: "Redis cache pod"
        created-by: "developer"
        restart-policy: "Always"
    
    spec:
      containers:
      - name: redis
        image: redis:7.0-alpine      # Redis 7.0 Alpine ì´ë¯¸ì§€ (ì‘ì€ í¬ê¸°)
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: redis
          containerPort: 6379
          protocol: TCP
        
        env:
        # Redis ë¹„ë°€ë²ˆí˜¸ (Secretì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: redis-password
        
        # ë©”ëª¨ë¦¬ ì„¤ì • (ConfigMapì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        - name: REDIS_MAX_MEMORY
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: redis-max-memory
        
        # ë©”ëª¨ë¦¬ ì •ì±… (ConfigMapì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        - name: REDIS_EVICTION_POLICY
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: redis-eviction-policy
        
        # ë°ì´í„°ë² ì´ìŠ¤ ë²ˆí˜¸
        - name: REDIS_DATABASE
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: redis-database
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          exec:
            command:
            - redis-cli
            - -a
            - $(REDIS_PASSWORD)
            - ping
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          exec:
            command:
            - redis-cli
            - -a
            - $(REDIS_PASSWORD)
            - ping
          initialDelaySeconds: 30
          periodSeconds: 15
          timeoutSeconds: 5
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "128Mi"           # RedisëŠ” ë©”ëª¨ë¦¬ íš¨ìœ¨ì´ ë†’ìŒ
            cpu: "100m"
          limits:
            memory: "256Mi"           # ìµœëŒ€ ë©”ëª¨ë¦¬ ì œí•œ
            cpu: "200m"
        
        # =============================================================================
        # ğŸ“ ë³¼ë¥¨ ë§ˆìš´íŠ¸
        # =============================================================================
        volumeMounts:
        - name: redis-data-volume
          mountPath: /data             # Redis ê¸°ë³¸ ë°ì´í„° ê²½ë¡œ
          subPath: redis
        
        - name: redis-config-volume
          mountPath: /usr/local/etc/redis/redis.conf
          subPath: redis.conf
          readOnly: true
        
        # =============================================================================
        # ğŸ”§ Redis ì‹¤í–‰ ëª…ë ¹ì–´ (ìµœì í™” ì„¤ì •)
        # =============================================================================
        command:
        - redis-server
        
        args:
        - /usr/local/etc/redis/redis.conf
        - --requirepass               # ë¹„ë°€ë²ˆí˜¸ ì¸ì¦
        - $(REDIS_PASSWORD)
        - --maxmemory                 # ìµœëŒ€ ë©”ëª¨ë¦¬ ì œí•œ
        - $(REDIS_MAX_MEMORY)
        - --maxmemory-policy          # ë©”ëª¨ë¦¬ ì •ì±…
        - $(REDIS_EVICTION_POLICY)
        - --save                     # RDB ë°±ì—… ì„¤ì •
        - "900 1"                     # 15ë¶„ ë™ì•ˆ 1ê°œ ì´ìƒ ë³€ê²½ ì‹œ ë°±ì—…
        - "300 10"                    # 5ë¶„ ë™ì•ˆ 10ê°œ ì´ìƒ ë³€ê²½ ì‹œ ë°±ì—…
        - "60 10000"                  # 1ë¶„ ë™ì•ˆ 10000ê°œ ì´ìƒ ë³€ê²½ ì‹œ ë°±ì—…
        - --appendonly                # AOF ë¡œê¹… í™œì„±í™”
        - "yes"
        - --appendfsync               # AOF ë™ê¸°í™” ë°©ì‹
        - "everysec"
        - --protected-mode            # ë³´ì•ˆ ëª¨ë“œ
        - "no"
      
      # =============================================================================
      # ğŸ“¦ ë³¼ë¥¨ ì •ì˜
      # =============================================================================
      volumes:
      - name: redis-data-volume
        persistentVolumeClaim:
          claimName: redis-pvc
      
      - name: redis-config-volume
        configMap:
          name: database-config
          items:
          - key: redis-init-script
            path: redis.conf
          optional: true

# =============================================================================
# ğŸŒŸ Redis ê´€ë¦¬ ëª…ë ¹ì–´
# =============================================================================
# 
# ë°°í¬ ìƒíƒœ í™•ì¸:
# kubectl get deployment redis-deployment -n web3-community
# kubectl get pods -l app=redis -n web3-community
#
# Redis ì ‘ì†:
# kubectl exec -it deployment/redis-deployment -n web3-community -- redis-cli -a $REDIS_PASSWORD
#
# ê¸°ë³¸ ëª…ë ¹ì–´ í…ŒìŠ¤íŠ¸:
# > SET user:session:123 "session_data"
# > GET user:session:123
# > KEYS user:*
# > DEL user:session:123
# > INFO memory
# > INFO stats
#
# ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§:
# kubectl exec deployment/redis-deployment -n web3-community -- \
#   redis-cli -a $REDIS_PASSWORD INFO memory
#
# ìºì‹œ í†µê³„:
# kubectl exec deployment/redis-deployment -n web3-community -- \
#   redis-cli -a $REDIS_PASSWORD INFO stats
#
# ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´:
# kubectl exec deployment/redis-deployment -n web3-community -- \
#   redis-cli -a $REDIS_PASSWORD INFO keyspace
#
# ë°±ì—… ìƒì„±:
# kubectl exec deployment/redis-deployment -n web3-community -- \
#   redis-cli -a $REDIS_PASSWORD BGSAVE
#
# ë°±ì—… í™•ì¸:
# kubectl exec deployment/redis-deployment -n web3-community -- ls -la /data/dump.rdb
#
# ì‹¤ë¬´ íŒ:
# - ìš´ì˜ í™˜ê²½ì—ì„œëŠ” Redis Sentinel + Cluster êµ¬ì„±
# - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ ë° ê²½ê³  ì„¤ì •
# - ì ì ˆí•œ Eviction ì •ì±…ìœ¼ë¡œ ë©”ëª¨ë¦¬ ê´€ë¦¬
# - ì •ê¸°ì ì¸ ë°±ì—… ë° ë³µì› í…ŒìŠ¤íŠ¸
# - Redis ë²„ì „ ê´€ë¦¬ ë° ì—…ê·¸ë ˆì´ë“œ ì „ëµ
# - ë³´ì•ˆì„ ìœ„í•´ ë„¤íŠ¸ì›Œí¬ ì •ì±… ì ìš©
# =============================================================================