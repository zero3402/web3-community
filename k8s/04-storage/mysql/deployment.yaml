# =============================================================================
# üê¨ MySQL Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Î∞∞Ìè¨
# =============================================================================
# üìù ÏÑ§Î™Ö: ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨Î•º ÏúÑÌïú MySQL 8.0 Í¥ÄÍ≥ÑÌòï Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Î∞∞Ìè¨
# üéØ Î™©Ï†Å: ÏòÅÍµ¨Ï†Å Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•, ACID Ìä∏ÎûúÏû≠ÏÖò ÏßÄÏõê, Ïú†Ï†Ä Ï†ïÎ≥¥ Í¥ÄÎ¶¨
# üåü Ïã§Î¨¥ ÌåÅ: Î°úÏª¨ Í∞úÎ∞úÏö© Deployment (Ïö¥ÏòÅÏùÄ StatefulSet Ï∂îÏ≤ú)
# ‚ö†Ô∏è  Ï£ºÏùò: Ïö¥ÏòÅ ÌôòÍ≤ΩÏóêÏÑúÎäî StatefulSet + Backup Ï†ÑÎûµ ÏÇ¨Ïö© Í∂åÏû•
# üîÑ Ïã§Ìñâ ÏàúÏÑú: #4-1-3 (PVC, Service ÏÉùÏÑ± ÌõÑ Ïã§Ìñâ)
# üìñ Ï∞∏Í≥†: https://kubernetes.io/docs/concepts/workloads/controllers/deployment/
# =============================================================================

apiVersion: apps/v1               # Kubernetes API Î≤ÑÏ†Ñ
kind: Deployment                   # Î∞∞Ìè¨ Í¥ÄÎ¶¨ Í∞ùÏ≤¥

metadata:
  name: mysql-deployment           # Î∞∞Ìè¨ Ïù¥Î¶Ñ (ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§ ÎÇ¥ Í≥†Ïú†)
  namespace: web3-community       # ÏÜåÏÜç ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§
  
  labels:
    app: web3-community
    component: database
    database: mysql
    tier: data
    environment: local
    deployment-type: database
  
  annotations:
    description: "MySQL 8.0 database deployment for user management"
    created-by: "developer"
    deployment-version: "v1.0"
    # Î°§ÎßÅ ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÑÎûµ Ïñ¥ÎÖ∏ÌÖåÏù¥ÏÖò
    kubernetes.io/rollout-version: "v1.0"

spec:
  # =============================================================================
  # üìä Î≥µÏ†úÎ≥∏ ÏÑ§Ï†ï
  # =============================================================================
  replicas: 1                      # Î°úÏª¨ Í∞úÎ∞ú ÌôòÍ≤ΩÏù¥ÎØÄÎ°ú 1Í∞ú Î≥µÏ†úÎ≥∏
  # Ïö¥ÏòÅ ÌôòÍ≤Ω: Í≥†Í∞ÄÏö©ÏÑ±ÏùÑ ÏúÑÌï¥ 3Í∞ú Ïù¥ÏÉÅ Í∂åÏû• (Ï£ºÏùò: Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî ÌïÑÏöî)
  
  # =============================================================================
  # üéØ ÏÖÄÎ†âÌÑ∞: Ïù¥ Î∞∞Ìè¨Í∞Ä Í¥ÄÎ¶¨Ìï† Pod ÏÑ†ÌÉù Í∏∞Ï§Ä
  # =============================================================================
  selector:
    matchLabels:
      app: mysql                   # Î∞òÎìúÏãú template.metadata.labelsÏôÄ ÏùºÏπòÌï¥Ïïº Ìï®
      component: database
      tier: data
  
  # =============================================================================
  # üèóÔ∏è Pod ÌÖúÌîåÎ¶ø: ÏÉùÏÑ±Îê† PodÏùò ÏÉÅÏÑ∏ ÏÑ§Ï†ï
  # =============================================================================
  template:
    metadata:
      labels:
        app: mysql
        component: database
        tier: data
        environment: local
        pod-template-hash: "auto-generated"  # DeploymentÍ∞Ä ÏûêÎèô ÏÉùÏÑ±
      
      annotations:
        description: "MySQL database pod"
        created-by: "developer"
        # Ïû¨ÏãúÏûë Ï†ïÏ±Ö
        restart-policy: "Always"
    
    spec:
      # =============================================================================
      # üè• Ïª®ÌÖåÏù¥ÎÑà ÏÑ§Ï†ï
      # =============================================================================
      containers:
      - name: mysql                 # Ïª®ÌÖåÏù¥ÎÑà Ïù¥Î¶Ñ
        image: mysql:8.0            # MySQL 8.0 Î≤ÑÏ†Ñ Ïù¥ÎØ∏ÏßÄ
        imagePullPolicy: IfNotPresent # Î°úÏª¨Ïóê ÏóÜÏùÑ ÎïåÎßå Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú
        
        # =============================================================================
        # üì° Ìè¨Ìä∏ ÏÑ§Ï†ï
        # =============================================================================
        ports:
        - name: mysql
          containerPort: 3306       # MySQL Í∏∞Î≥∏ Ìè¨Ìä∏
          protocol: TCP
        
        # =============================================================================
        # üîß ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
        # =============================================================================
        env:
        # MySQL Root ÎπÑÎ∞ÄÎ≤àÌò∏ (SecretÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞)
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: mysql-root-password
        
        # Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïù¥Î¶Ñ (ConfigMapÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞)
        - name: MYSQL_DATABASE
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: mysql-database-name
        
        # ÏùºÎ∞ò ÏÇ¨Ïö©Ïûê Í≥ÑÏ†ï
        - name: MYSQL_USER
          value: "web3user"
        
        # ÏùºÎ∞ò ÏÇ¨Ïö©Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏ (SecretÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞)
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: mysql-password
        
        # Î¨∏ÏûêÏÖã ÏÑ§Ï†ï (ConfigMapÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞)
        - name: MYSQL_CHARSET
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: mysql-charset
        
        # Ï†ïÎ†¨ Í∑úÏπô (ConfigMapÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞)
        - name: MYSQL_COLLATION
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: mysql-collation
        
        # =============================================================================
        # üè• Ìó¨Ïä§Ï≤¥ÌÅ¨: Ïª®ÌÖåÏù¥ÎÑà ÏÉÅÌÉú ÌôïÏù∏ (Îß§Ïö∞ Ï§ëÏöî!)
        # =============================================================================
        # Readiness Probe: Ìä∏ÎûòÌîΩ Î∞õÏùÑ Ï§ÄÎπÑÎêòÏóàÎäîÏßÄ ÌôïÏù∏
        readinessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
          initialDelaySeconds: 30    # Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë ÌõÑ 30Ï¥à ÎåÄÍ∏∞
          periodSeconds: 10          # 10Ï¥àÎßàÎã§ Ï≤¥ÌÅ¨
          timeoutSeconds: 5           # 5Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
          failureThreshold: 3          # 3Î≤à Ïó∞ÏÜç Ïã§Ìå®Ïãú ÎπÑÏ§ÄÎπÑ ÏÉÅÌÉú
          successThreshold: 1          # 1Î≤à ÏÑ±Í≥µÏãú Ï§ÄÎπÑ ÏÉÅÌÉú
        
        # Liveness Probe: Ïª®ÌÖåÏù¥ÎÑàÍ∞Ä ÏÇ¥ÏïÑÏûàÎäîÏßÄ ÌôïÏù∏ (ÏûêÎèô Ïû¨ÏãúÏûë)
        livenessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
          initialDelaySeconds: 60    # readinessÎ≥¥Îã§ Í∏∏Í≤å ÏÑ§Ï†ï
          periodSeconds: 30           # 30Ï¥àÎßàÎã§ Ï≤¥ÌÅ¨
          timeoutSeconds: 10          # 10Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
          failureThreshold: 2          # 2Î≤à Ïó∞ÏÜç Ïã§Ìå®Ïãú Ïª®ÌÖåÏù¥ÎÑà Ïû¨ÏãúÏûë
          successThreshold: 1
        
        # =============================================================================
        # üíæ Î¶¨ÏÜåÏä§ Í¥ÄÎ¶¨: ÏãúÏä§ÌÖú Î¶¨ÏÜåÏä§ ÏÇ¨Ïö©Îüâ Ï†úÌïú (Ïã§Î¨¥ ÌïÑÏàò!)
        # =============================================================================
        resources:
          # ÏµúÏÜå Î≥¥Ïû• Î¶¨ÏÜåÏä§ (Requests)
          requests:
            memory: "512Mi"           # ÏµúÏÜå 512MB Î©îÎ™®Î¶¨ Î≥¥Ïû•
            cpu: "250m"               # ÏµúÏÜå 0.25 CPU ÏΩîÏñ¥ Î≥¥Ïû•
          
          # ÏµúÎåÄ ÏÇ¨Ïö© Î¶¨ÏÜåÏä§ (Limits)
          limits:
            memory: "1Gi"             # ÏµúÎåÄ 1GB Î©îÎ™®Î¶¨ ÏÇ¨Ïö©
            cpu: "500m"               # ÏµúÎåÄ 0.5 CPU ÏΩîÏñ¥ ÏÇ¨Ïö©
        
        # =============================================================================
        # üìÅ Î≥ºÎ•® ÎßàÏö¥Ìä∏: Îç∞Ïù¥ÌÑ∞ ÏòÅÏÜçÏÑ± Î≥¥Ïû•
        # =============================================================================
        volumeMounts:
        # MySQL Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïö© Î≥ºÎ•®
        - name: mysql-data-volume
          mountPath: /var/lib/mysql    # MySQL Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Í≤ΩÎ°ú
          subPath: mysql               # PVC ÎÇ¥Î∂Ä ÏÑúÎ∏åÍ≤ΩÏò§Î°ú Ï∂©Îèå Î∞©ÏßÄ
        
        # MySQL ÏÑ§Ï†ï ÌååÏùºÏö© Î≥ºÎ•® (ÏÑ†ÌÉùÏÇ¨Ìï≠)
        - name: mysql-config-volume
          mountPath: /etc/mysql/conf.d/custom.cnf
          subPath: custom.cnf
          readOnly: true               # ÏùΩÍ∏∞ Ï†ÑÏö© ÎßàÏö¥Ìä∏
      
      # =============================================================================
      # üì¶ Î≥ºÎ•® Ï†ïÏùò
      # =============================================================================
      volumes:
      # MySQL Îç∞Ïù¥ÌÑ∞Ïö© PVC
      - name: mysql-data-volume
        persistentVolumeClaim:
          claimName: mysql-pvc        # ÏúÑÏóêÏÑú ÏÉùÏÑ±Ìïú PVC Ïù¥Î¶Ñ
      
      # MySQL ÏÑ§Ï†ïÏö© ConfigMap (ÏÑ†ÌÉùÏÇ¨Ìï≠)
      - name: mysql-config-volume
        configMap:
          name: mysql-config          # MySQL ÏÑ§Ï†ï ConfigMap (Î≥ÑÎèÑÎ°ú Ï†ïÏùò)
          optional: true               # ConfigMapÏù¥ ÏóÜÏñ¥ÎèÑ ÌååÎìú ÏÉùÏÑ± ÌóàÏö©
      
      # =============================================================================
      # üåü Ïã§Î¨¥ ÌåÅ: Í≥†Í∏â ÏÑ§Ï†ï (ÌïÑÏöîÏãú Ï£ºÏÑù Ìï¥Ï†ú)
      # =============================================================================
      # # Pod Anti-Affinity: Í∞ôÏùÄ ÎÖ∏ÎìúÏóê Ïó¨Îü¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Í∞Ä Î∞∞ÏπòÎêòÏßÄ ÏïäÎèÑÎ°ù
      # affinity:
      #   podAntiAffinity:
      #     preferredDuringSchedulingIgnoredDuringExecution:
      #     - weight: 100
      #       podAffinityTerm:
      #         labelSelector:
      #           matchLabels:
      #             component: database
      #         topologyKey: kubernetes.io/hostname
      
      # # ÎÖ∏Îìú ÏÖÄÎ†âÌÑ∞: ÌäπÏ†ï ÎÖ∏ÎìúÏóêÎßå Î∞∞Ìè¨ (SSD ÎÖ∏Îìú Îì±)
      # nodeSelector:
      #   storage-type: ssd
      #   node-type: database
      
      # # ÌÜ®Îü¨Î†àÏù¥ÏÖò: ÌäπÏ†ï Ï°∞Í±¥ÏóêÏÑúÎèÑ Î∞∞Ìè¨ ÌóàÏö©
      # tolerations:
      # - key: "database"
      #   operator: "Equal"
      #   value: "true"
      #   effect: "NoSchedule"

# =============================================================================
# üîÑ Î°§ÎßÅ ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÑÎûµ
# =============================================================================
# spec.strategy.type: RollingUpdate (Í∏∞Î≥∏Í∞í)
# spec.strategy.rollingUpdate:
#   maxUnavailable: 25%  # ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë ÏµúÎåÄ 25%ÍπåÏßÄ Ï§ëÎã® ÌóàÏö©
#   maxSurge: 25%        # ÏµúÎåÄ 25%ÍπåÏßÄ Ï∂îÍ∞Ä ÏÉùÏÑ± ÌóàÏö©
#
# =============================================================================
# üåü Ïã§Î¨¥ Ïö¥ÏòÅ Í∞ÄÏù¥Îìú
# =============================================================================
# 
# MySQL Î∞∞Ìè¨ ÌôïÏù∏:
# kubectl get deployment mysql-deployment -n web3-community
# kubectl get pods -l app=mysql -n web3-community
# kubectl describe deployment mysql-deployment -n web3-community
#
# Î°úÍ∑∏ ÌôïÏù∏:
# kubectl logs deployment/mysql-deployment -n web3-community -f
#
# Ïä§ÏºÄÏùºÎßÅ:
# kubectl scale deployment mysql-deployment --replicas=3 -n web3-community
#
# Î°§ÏïÑÏõÉ ÏÉÅÌÉú:
# kubectl rollout status deployment/mysql-deployment -n web3-community
# kubectl rollout history deployment/mysql-deployment -n web3-community
#
# Î°§Î∞±:
# kubectl rollout undo deployment/mysql-deployment -n web3-community
#
# MySQL Ï†ëÏÜç ÌÖåÏä§Ìä∏:
# kubectl exec -it deployment/mysql-deployment -n web3-community -- mysql -u root -p
#
# Î∞±ÏóÖ (Î°úÏª¨ Í∞úÎ∞úÏö©):
# kubectl exec deployment/mysql-deployment -n web3-community -- \
#   mysqldump -u root -p$MYSQL_ROOT_PASSWORD web3_community > backup.sql
#
# Î≥µÏõê:
# kubectl exec -i deployment/mysql-deployment -n web3-community -- \
#   mysql -u root -p$MYSQL_ROOT_PASSWORD web3_community < backup.sql
#
# Ïã§Î¨¥ ÌåÅ:
# - Ïö¥ÏòÅ ÌôòÍ≤ΩÏóêÏÑúÎäî StatefulSet + Backup Ï†ÑÎûµ ÏÇ¨Ïö©
# - Ï†ïÍ∏∞Ï†ÅÏù∏ Î∞±ÏóÖ Î∞è Î≥µÏõê ÌÖåÏä§Ìä∏ ÌïÑÏàò
# - Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Î™®ÎãàÌÑ∞ÎßÅ Î∞è ÏÑ±Îä• ÌäúÎãù
# - ÎÑ§Ìä∏ÏõåÌÅ¨ Ï†ïÏ±ÖÏúºÎ°ú Ï†ëÍ∑º Ï†úÏñ¥ Í∞ïÌôî
# =============================================================================