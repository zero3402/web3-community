# =============================================================================
# ğŸ¦ Zookeeper ë°ì´í„°ë² ì´ìŠ¤ ë°°í¬
# =============================================================================
# ğŸ“ ì„¤ëª…: Kafka í´ëŸ¬ìŠ¤í„° ê´€ë¦¬ë¥¼ ìœ„í•œ Zookeeper 3.8 ë°°í¬
# ğŸ¯ ëª©ì : ë¶„ì‚° ì¡°ì • ì„œë¹„ìŠ¤, ë¦¬ë” ì„ ê±°, ë©”íƒ€ë°ì´í„° ê´€ë¦¬
# ğŸŒŸ ì‹¤ë¬´ íŒ: Kafka ì„ í–‰ ì¡°ê±´, ì•ˆì •ì„±ê³¼ ì¼ê´€ì„±ì´ ì¤‘ìš”
# âš ï¸  ì£¼ì˜: í™€ìˆ˜ ê°œì˜ ë…¸ë“œë¡œ êµ¬ì„±í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì  (3, 5, 7...)
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #4-4-4 (PVC, Service ìƒì„± í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://zookeeper.apache.org/
# =============================================================================

apiVersion: apps/v1
kind: Deployment

metadata:
  name: zookeeper-deployment     # ë°°í¬ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ìŠ¤
  
  labels:
    app: web3-community
    component: database
    database: zookeeper
    tier: data
    environment: local
    deployment-type: coordination
  
  annotations:
    description: "Zookeeper 3.8 deployment for Kafka coordination"
    created-by: "developer"
    deployment-version: "v1.0"

spec:
  replicas: 1                      # ë¡œì»¬ ê°œë°œìš© 1ê°œ (ìš´ì˜ì€ 3ê°œ ê¶Œì¥)
  
  selector:
    matchLabels:
      app: zookeeper
      component: database
      tier: data
  
  template:
    metadata:
      labels:
        app: zookeeper
        component: database
        tier: data
        environment: local
        pod-template-hash: "auto-generated"
      
      annotations:
        description: "Zookeeper coordination pod"
        created-by: "developer"
        restart-policy: "Always"
    
    spec:
      containers:
      - name: zookeeper
        image: confluentinc/cp-zookeeper:7.3.0  # Confluent Platform Zookeeper
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: zookeeper-client
          containerPort: 2181
          protocol: TCP
        
        - name: zookeeper-server
          containerPort: 2888
          protocol: TCP
        
        - name: zookeeper-election
          containerPort: 3888
          protocol: TCP
        
        env:
        # Zookeeper ID (ê° ë…¸ë“œë§ˆë‹¤ ê³ ìœ  ID í•„ìš”)
        - name: ZOOKEEPER_SERVER_ID
          value: "1"
        
        # í´ëŸ¬ìŠ¤í„° êµ¬ì„± ì •ë³´
        - name: ZOOKEEPER_CLIENT_PORT
          value: "2181"
        
        - name: ZOOKEEPER_SERVERS
          value: "zookeeper-service:2888:3888"
        
        # ë°ì´í„° ë””ë ‰í† ë¦¬
        - name: ZOOKEEPER_DATA_DIR
          value: "/var/lib/zookeeper/data"
        
        # ë¡œê·¸ ë””ë ‰í† ë¦¬
        - name: ZOOKEEPER_LOG_DIR
          value: "/var/lib/zookeeper/log"
        
        # í‹± ì„¤ì • (ì„±ëŠ¥ íŠœë‹)
        - name: ZOOKEEPER_TICK_TIME
          value: "2000"
        
        - name: ZOOKEEPER_SYNC_LIMIT
          value: "2"
        
        - name: ZOOKEEPER_INIT_LIMIT
          value: "5"
        
        - name: ZOOKEEPER_MAX_CLIENT_CNXNS
          value: "60"
        
        - name: ZOOKEEPER_AUTOPURGE_SNAPRETAINCOUNT
          value: "3"
        
        - name: ZOOKEEPER_AUTOPURGE_PURGEINTERVAL
          value: "1"
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - echo "ruok" | nc localhost 2181 | grep imok
          initialDelaySeconds: 20
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - echo "ruok" | nc localhost 2181 | grep imok
          initialDelaySeconds: 40
          periodSeconds: 20
          timeoutSeconds: 10
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        
        # =============================================================================
        # ğŸ“ ë³¼ë¥¨ ë§ˆìš´íŠ¸
        # =============================================================================
        volumeMounts:
        - name: zookeeper-data-volume
          mountPath: /var/lib/zookeeper/data
          subPath: data
        
        - name: zookeeper-data-volume
          mountPath: /var/lib/zookeeper/log
          subPath: log
        
        # =============================================================================
        # ğŸ”§ Zookeeper ì‹¤í–‰ ëª…ë ¹ì–´
        # =============================================================================
        command:
        - /bin/bash
        - -c
        - |
          # ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /var/lib/zookeeper/data /var/lib/zookeeper/log
          
          # myid íŒŒì¼ ìƒì„± (ê° ë…¸ë“œë§ˆë‹¤ ê³ ìœ  ID)
          echo $ZOOKEEPER_SERVER_ID > /var/lib/zookeeper/data/myid
          
          # Zookeeper ì‹œì‘
          exec /etc/confluent/docker/run
      
      # =============================================================================
      # ğŸ“¦ ë³¼ë¥¨ ì •ì˜
      # =============================================================================
      volumes:
      - name: zookeeper-data-volume
        persistentVolumeClaim:
          claimName: zookeeper-pvc

---

# =============================================================================
# ğŸ“¡ Kafka ë°ì´í„°ë² ì´ìŠ¤ ë°°í¬
# =============================================================================
# ğŸ“ ì„¤ëª…: ë¶„ì‚° ë©”ì‹œì§• ì‹œìŠ¤í…œ Kafka 3.3 ë°°í¬
# ğŸ¯ ëª©ì : ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜, ë¹„ë™ê¸° ë©”ì‹œì§•, ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë°
# ğŸŒŸ ì‹¤ë¬´ íŒ: íŒŒí‹°ì…˜, ë³µì œ, ë³´ì¡´ ì •ì±… ì„¤ì •ì´ ì¤‘ìš”
# âš ï¸  ì£¼ì˜: Zookeeper ë¨¼ì € ì‹¤í–‰í•˜ê³  Kafka ì‹¤í–‰í•´ì•¼ í•¨
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #4-4-5 (Zookeeper ì‹¤í–‰ í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://kafka.apache.org/
# =============================================================================

apiVersion: apps/v1
kind: Deployment

metadata:
  name: kafka-deployment         # ë°°í¬ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: database
    database: kafka
    tier: data
    environment: local
    deployment-type: messaging
  
  annotations:
    description: "Kafka 3.3 deployment for event messaging"
    created-by: "developer"
    deployment-version: "v1.0"

spec:
  replicas: 1                      # ë¡œì»¬ ê°œë°œìš© 1ê°œ (ìš´ì˜ì€ 3ê°œ ì´ìƒ ê¶Œì¥)
  
  selector:
    matchLabels:
      app: kafka
      component: database
      tier: data
  
  template:
    metadata:
      labels:
        app: kafka
        component: database
        tier: data
        environment: local
        pod-template-hash: "auto-generated"
      
      annotations:
        description: "Kafka messaging pod"
        created-by: "developer"
        restart-policy: "Always"
    
    spec:
      containers:
      - name: kafka
        image: confluentinc/cp-kafka:7.3.0  # Confluent Platform Kafka
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: kafka-broker
          containerPort: 9092
          protocol: TCP
        
        env:
        # ë¸Œë¡œì»¤ ID (ê° ë…¸ë“œë§ˆë‹¤ ê³ ìœ  ID í•„ìš”)
        - name: KAFKA_BROKER_ID
          value: "1"
        
        # Zookeeper ì ‘ì† ì •ë³´
        - name: KAFKA_ZOOKEEPER_CONNECT
          value: "zookeeper-service:2181"
        
        # ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
          value: "PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
        
        - name: KAFKA_ADVERTISED_LISTENERS
          value: "PLAINTEXT://kafka-service:9092,PLAINTEXT_HOST://kafka-service:9092"
        
        - name: KAFKA_INTER_BROKER_LISTENER_NAME
          value: "PLAINTEXT"
        
        - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
          value: "1"
        
        - name: KAFKA_TRANSACTION_STATE_LOG_MIN_ISR
          value: "1"
        
        - name: KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR
          value: "1"
        
        - name: KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS
          value: "0"
        
        # ë¡œê·¸ ì„¤ì •
        - name: KAFKA_LOG_DIRS
          value: "/var/lib/kafka/data"
        
        # í† í”½ ê¸°ë³¸ ì„¤ì • (ConfigMapì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        - name: KAFKA_NUM_PARTITIONS
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: kafka-partitions-per-topic
        
        - name: KAFKA_DEFAULT_REPLICATION_FACTOR
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: kafka-replication-factor
        
        # ë¡œê·¸ ë³´ê´€ ì •ì±…
        - name: KAFKA_LOG_RETENTION_HOURS
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: kafka-retention-hours
        
        - name: KAFKA_LOG_SEGMENT_BYTES
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: kafka-segment-bytes
        
        - name: KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS
          valueFrom:
            configMapKeyRef:
              name: database-config
              key: kafka-log-retention-check-interval-ms
        
        # JMX ëª¨ë‹ˆí„°ë§ í™œì„±í™”
        - name: KAFKA_JMX_PORT
          value: "9999"
        
        - name: KAFKA_JMX_HOSTNAME
          value: "localhost"
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - |
              # Kafka ë¸Œë¡œì»¤ ìƒíƒœ í™•ì¸
              kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          exec:
            command:
            - /bin/bash
            - -c
            - |
              # Kafka ë¸Œë¡œì»¤ ìƒíƒœ í™•ì¸
              kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 15
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "1Gi"              # KafkaëŠ” ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë§ìŒ
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        
        # =============================================================================
        # ğŸ“ ë³¼ë¥¨ ë§ˆìš´íŠ¸
        # =============================================================================
        volumeMounts:
        - name: kafka-data-volume
          mountPath: /var/lib/kafka/data
          subPath: kafka
        
        # =============================================================================
        # ğŸ”§ Kafka ì‹¤í–‰ ëª…ë ¹ì–´
        # =============================================================================
        command:
        - /bin/bash
        - -c
        - |
          # ë°ì´í„° ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p /var/lib/kafka/data
          
          # Kafka ì‹œì‘
          exec /etc/confluent/docker/run
      
      # =============================================================================
      # ğŸ“¦ ë³¼ë¥¨ ì •ì˜
      # =============================================================================
      volumes:
      - name: kafka-data-volume
        persistentVolumeClaim:
          claimName: kafka-pvc

# =============================================================================
# ğŸŒŸ Kafka & Zookeeper ê´€ë¦¬ ëª…ë ¹ì–´
# =============================================================================
# 
# ë°°í¬ ìƒíƒœ í™•ì¸:
# kubectl get deployment zookeeper-deployment kafka-deployment -n web3-community
# kubectl get pods -l component=database -n web3-community
#
# Zookeeper ìƒíƒœ í™•ì¸:
# kubectl exec deployment/zookeeper-deployment -n web3-community -- \
#   zookeeper-shell zookeeper-service:2181
# > ls /brokers/ids
# > ls /topics
#
# Kafka ìƒíƒœ í™•ì¸:
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-broker-api-versions --bootstrap-server localhost:9092
#
# í† í”½ ìƒì„±:
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-topics --bootstrap-server localhost:9092 \
#   --create --topic notifications --partitions 3 --replication-factor 1
#
# í† í”½ ëª©ë¡:
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-topics --bootstrap-server localhost:9092 --list
#
# ë©”ì‹œì§€ ì „ì†¡:
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-console-producer --bootstrap-server localhost:9092 --topic notifications
# > {"type":"notification","message":"Hello Kafka!"}
#
# ë©”ì‹œì§€ ìˆ˜ì‹ :
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-console-consumer --bootstrap-server localhost:9092 --topic notifications --from-beginning
#
# í† í”½ ìƒì„¸ ì •ë³´:
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-topics --bootstrap-server localhost:9092 --describe --topic notifications
#
# ì»¨ìŠˆë¨¸ ê·¸ë£¹ ìƒíƒœ:
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-consumer-groups --bootstrap-server localhost:9092 --list
#
# ì‹¤ë¬´ íŒ:
# - ìš´ì˜ í™˜ê²½ì—ì„œëŠ” Zookeeper 3ê°œ, Kafka 3ê°œ ì´ìƒ ê¶Œì¥
# - í† í”½ íŒŒí‹°ì…˜ê³¼ ë³µì œ ì „ëµ ì‹ ì¤‘íˆ ì„¤ê³„
# - ëª¨ë‹ˆí„°ë§: JMX ë©”íŠ¸ë¦­, Prometheus ì—°ë™
# - ë°±ì—… ë° ì¬í•´ ë³µêµ¬ ì „ëµ í•„ìˆ˜
# - ë³´ì•ˆ: SSL/TLS, SASL ì¸ì¦ ì ìš©
# - íŒŒì´í”„ë¼ì¸ ëª¨ë‹ˆí„°ë§ ë° ì„±ëŠ¥ íŠœë‹
# =============================================================================