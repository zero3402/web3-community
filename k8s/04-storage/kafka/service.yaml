# =============================================================================
# π“΅ Kafka & Zookeeper μ„λΉ„μ¤ μ •μ
# =============================================================================
# π“ μ„¤λ…: Kafka λ©”μ‹μ§• μ‹μ¤ν…κ³Ό Zookeeper μ ‘μ†μ„ μ„ν• λ„¤νΈμ›ν¬ μ„λΉ„μ¤
# π― λ©μ : λ©”μ‹μ§• ν μ ‘μ† μ—”λ“ν¬μΈνΈ μ κ³µ, ν΄λ¬μ¤ν„° ν†µμ‹  μ§€μ›
# π μ‹¤λ¬΄ ν: Zookeeperλ” λ‚΄λ¶€ ν†µμ‹ λ§, Kafkaλ” λ‚΄λ¶€/μ™Έλ¶€ ν†µμ‹  λ¶„λ¦¬
# π”„ μ‹¤ν–‰ μμ„: #4-4-3 (PVC μƒμ„± ν›„ μ‹¤ν–‰)
# π“– μ°Έκ³ : https://kubernetes.io/docs/concepts/services-networking/service/
# =============================================================================

# =============================================================================
# π“΅ Kafka μ„λΉ„μ¤ μ •μ
# =============================================================================
apiVersion: v1
kind: Service

metadata:
  name: kafka-service             # Kafka μ„λΉ„μ¤ μ΄λ¦„
  namespace: web3-community     # μ†μ† λ„¤μ„μ¤νμ΄μ¤
  
  labels:
    app: web3-community
    component: database
    database: kafka
    tier: data
    service-type: messaging
    environment: local
  
  annotations:
    description: "Kafka messaging service endpoint"
    created-by: "developer"

spec:
  type: ClusterIP                 # ν΄λ¬μ¤ν„° λ‚΄λ¶€ μ ‘μ†
  
  selector:
    app: kafka
    component: database
    tier: data
  
  ports:
    - name: kafka-broker          # λΈλ΅μ»¤ ν¬νΈ
      protocol: TCP
      port: 9092
      targetPort: 9092

---

# =============================================================================
# π¦ Zookeeper μ„λΉ„μ¤ μ •μ
# =============================================================================
apiVersion: v1
kind: Service

metadata:
  name: zookeeper-service         # Zookeeper μ„λΉ„μ¤ μ΄λ¦„
  namespace: web3-community     # μ†μ† λ„¤μ„μ¤νμ΄μ¤
  
  labels:
    app: web3-community
    component: database
    database: zookeeper
    tier: data
    service-type: coordination
    environment: local
  
  annotations:
    description: "Zookeeper coordination service"
    created-by: "developer"

spec:
  type: ClusterIP                 # ν΄λ¬μ¤ν„° λ‚΄λ¶€ μ ‘μ†
  
  selector:
    app: zookeeper
    component: database
    tier: data
  
  ports:
    - name: zookeeper-client       # ν΄λΌμ΄μ–ΈνΈ μ ‘μ† ν¬νΈ
      protocol: TCP
      port: 2181
      targetPort: 2181
    
    - name: zookeeper-server       # μ„λ²„ κ°„ ν†µμ‹  ν¬νΈ
      protocol: TCP
      port: 2888
      targetPort: 2888
    
    - name: zookeeper-election     # λ¦¬λ” μ„ κ±° ν¬νΈ
      protocol: TCP
      port: 3888
      targetPort: 3888

---

# =============================================================================
# π Kafka Headless Service (ν΄λ¬μ¤ν„°λ§μ©)
# =============================================================================
apiVersion: v1
kind: Service

metadata:
  name: kafka-headless           # Kafka Headless Service
  namespace: web3-community     # μ†μ† λ„¤μ„μ¤νμ΄μ¤
  
  labels:
    app: web3-community
    component: database
    database: kafka
    tier: data
    service-type: headless
    environment: local
  
  annotations:
    description: "Headless service for Kafka cluster"
    created-by: "developer"

spec:
  clusterIP: None                 # Headless Service
  
  selector:
    app: kafka
    component: database
    tier: data
  
  ports:
    - name: kafka-broker
      protocol: TCP
      port: 9092
      targetPort: 9092

---

# =============================================================================
# π¦ Zookeeper Headless Service (ν΄λ¬μ¤ν„°λ§μ©)
# =============================================================================
apiVersion: v1
kind: Service

metadata:
  name: zookeeper-headless       # Zookeeper Headless Service
  namespace: web3-community     # μ†μ† λ„¤μ„μ¤νμ΄μ§€
  
  labels:
    app: web3-community
    component: database
    database: zookeeper
    tier: data
    service-type: headless
    environment: local
  
  annotations:
    description: "Headless service for Zookeeper cluster"
    created-by: "developer"

spec:
  clusterIP: None                 # Headless Service
  
  selector:
    app: zookeeper
    component: database
    tier: data
  
  ports:
    - name: zookeeper-client
      protocol: TCP
      port: 2181
      targetPort: 2181
    
    - name: zookeeper-server
      protocol: TCP
      port: 2888
      targetPort: 2888
    
    - name: zookeeper-election
      protocol: TCP
      port: 3888
      targetPort: 3888

# =============================================================================
# π μ„λΉ„μ¤ μ ‘μ† λ°©λ²•
# =============================================================================
# 
# Kafka μ ‘μ†:
# - Bootstrap: kafka-service.web3-community.svc.cluster.local:9092
# - κ°„λ‹¨ν: kafka-service:9092
# - Headless: kafka-0.kafka-headless.web3-community.svc.cluster.local:9092
#
# Zookeeper μ ‘μ†:
# - Client: zookeeper-service.web3-community.svc.cluster.local:2181
# - κ°„λ‹¨ν: zookeeper-service:2181
#
# Spring Boot μ„¤μ • μμ‹:
# spring:
#   kafka:
#     bootstrap-servers: kafka-service:9092
#     consumer:
#       group-id: web3-community
#       auto-offset-reset: earliest
#     producer:
#       acks: all
#       retries: 3
#
# Kafka ν΄λΌμ΄μ–ΈνΈ ν…μ¤νΈ:
# kubectl run kafka-client --image=confluentinc/cp-kafka:latest --rm -it --restart=Never \
#   -- kafka-topics --bootstrap-server kafka-service:9092 --list
#
# Kafka ν† ν”½ μƒμ„±:
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-topics --bootstrap-server localhost:9092 --create --topic test-topic --partitions 3 --replication-factor 1
#
# λ©”μ‹μ§€ μ „μ†΅:
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-console-producer --bootstrap-server localhost:9092 --topic test-topic
#
# λ©”μ‹μ§€ μμ‹ :
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-console-consumer --bootstrap-server localhost:9092 --topic test-topic --from-beginning
#
# Zookeeper μƒνƒ ν™•μΈ:
# kubectl exec deployment/zookeeper-deployment -n web3-community -- \
#   zookeeper-shell zookeeper-service:2181
# > ls /
# > get /brokers/ids
#
# μ‹¤λ¬΄ ν:
# - Kafkaλ” λ†’μ€ μ²λ¦¬λ‰μ„ μ„ν•΄ Headless Service ν•„μ”
# - Zookeeperλ” ν™€μ κ°μ λ…Έλ“λ΅ κµ¬μ„± (3, 5, 7...)
# - μ΄μ ν™κ²½μ—μ„λ” κ° μ„λΉ„μ¤λ³„λ΅ λ³„λ„ λ„¤μ„μ¤νμ΄μ¤ λ¶„λ¦¬
# - λ„¤νΈμ›ν¬ μ •μ±…μΌλ΅ λ³΄μ• κ°•ν™”
# - λ¨λ‹ν„°λ§: JMX λ©”νΈλ¦­ μμ§‘
# =============================================================================