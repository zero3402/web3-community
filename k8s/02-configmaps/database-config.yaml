# =============================================================================
# âš™ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ë§µ
# =============================================================================
# ğŸ“ ì„¤ëª…: MySQL, MongoDB, Redis, Kafka ë°ì´í„°ë² ì´ìŠ¤ë“¤ì˜ ì—°ê²° ë° ì„¤ì • ê´€ë¦¬
# ğŸ¯ ëª©ì : ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì¤‘ì•™ ê´€ë¦¬, í™˜ê²½ë³„ ì„¤ì • ìš©ì´ì„±
# ğŸ”’ ë³´ì•ˆ: ë¯¼ê° ì •ë³´(ë¹„ë°€ë²ˆí˜¸ ë“±)ëŠ” Secretsì— ë³„ë„ ì €ì¥
# ğŸŒŸ ì‹¤ë¬´ íŒ: ë°ì´í„°ë² ì´ìŠ¤ë³„ ConfigMap ë¶„ë¦¬ë¡œ ë…ë¦½ì  ê´€ë¦¬
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #2-3 (ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://kubernetes.io/docs/concepts/configuration/configmap/
# =============================================================================

apiVersion: v1
kind: ConfigMap

metadata:
  name: database-config
  namespace: web3-community
  
  labels:
    app: web3-community
    component: database
    config-type: database
    tier: data
  
  annotations:
    description: "Database configuration for all services"
    config-version: "v1.0"

data:
  # =============================================================================
  # ğŸ¬ MySQL ì„¤ì • (ì‚¬ìš©ì ê´€ë¦¬ìš©)
  # =============================================================================
  mysql-database-name: "web3_community"
  mysql-charset: "utf8mb4"
  mysql-collation: "utf8mb4_unicode_ci"
  mysql-storage-engine: "InnoDB"
  
  # MySQL ìµœì í™” ì„¤ì •
  mysql-innodb-buffer-pool-size: "512M"
  mysql-max-connections: "200"
  mysql-query-cache-size: "64M"
  mysql-query-cache-type: "1"
  mysql-slow-query-log: "1"
  mysql-long-query-time: "2"
  
  # MySQL ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
  mysql-init-script: |
    -- ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
    CREATE DATABASE IF NOT EXISTS web3_community 
    CHARACTER SET utf8mb4 
    COLLATE utf8mb4_unicode_ci;
    
    -- ì‚¬ìš©ì ìƒì„±
    CREATE USER IF NOT EXISTS 'web3user'@'%' IDENTIFIED BY 'userpassword';
    GRANT ALL PRIVILEGES ON web3_community.* TO 'web3user'@'%';
    FLUSH PRIVILEGES;
    
    -- í…Œì´ë¸” ìƒì„± (ê¸°ë³¸ êµ¬ì¡°)
    USE web3_community;
    
    CREATE TABLE IF NOT EXISTS users (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        username VARCHAR(50) NOT NULL UNIQUE,
        email VARCHAR(100) NOT NULL UNIQUE,
        password_hash VARCHAR(255) NOT NULL,
        nickname VARCHAR(50) NOT NULL,
        profile_image VARCHAR(255),
        status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') DEFAULT 'ACTIVE',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        INDEX idx_username (username),
        INDEX idx_email (email),
        INDEX idx_status (status)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    
    CREATE TABLE IF NOT EXISTS user_roles (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        user_id BIGINT NOT NULL,
        role ENUM('USER', 'ADMIN', 'MODERATOR') DEFAULT 'USER',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_user_role (user_id, role)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

  # =============================================================================
  # ğŸƒ MongoDB ì„¤ì • (ê²Œì‹œê¸€/ëŒ“ê¸€ìš©)
  # =============================================================================
  mongodb-database-name: "web3_posts"
  mongodb-replica-set: "rs0"
  mongodb-connection-timeout: "30000"
  mongodb-socket-timeout: "30000"
  mongodb-server-selection-timeout: "30000"
  
  # MongoDB ìµœì í™” ì„¤ì •
  mongodb-pool-size: "10"
  mongodb-max-connection-per-host: "10"
  mongodb-threads-allowed-to-block-for-connection-multiplier: "5"
  
  # MongoDB ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
  mongodb-init-script: |
    // ë°ì´í„°ë² ì´ìŠ¤ ìƒì„± ë° ì‚¬ìš©ì ì„¤ì •
    use web3_posts;
    
    // ì‚¬ìš©ì ìƒì„±
    db.createUser({
      user: "mongouser",
      pwd: "mongopass",
      roles: [
        {
          role: "readWrite",
          db: "web3_posts"
        }
      ]
    });
    
    // ì»¬ë ‰ì…˜ ë° ì¸ë±ìŠ¤ ìƒì„±
    // ê²Œì‹œê¸€ ì»¬ë ‰ì…˜
    db.createCollection("posts");
    db.posts.createIndex({ "title": "text", "content": "text" });
    db.posts.createIndex({ "authorId": 1 });
    db.posts.createIndex({ "createdAt": -1 });
    db.posts.createIndex({ "status": 1 });
    db.posts.createIndex({ "tags": 1 });
    
    // ëŒ“ê¸€ ì»¬ë ‰ì…˜
    db.createCollection("comments");
    db.comments.createIndex({ "postId": 1 });
    db.comments.createIndex({ "authorId": 1 });
    db.comments.createIndex({ "parentId": 1 });
    db.comments.createIndex({ "createdAt": -1 });
    
    // íŒŒì¼ ì—…ë¡œë“œ ì»¬ë ‰ì…˜
    db.createCollection("attachments");
    db.attachments.createIndex({ "postId": 1 });
    db.attachments.createIndex({ "uploadDate": -1 });
    
    print("MongoDB initialization completed successfully!");

  # =============================================================================
  # ğŸ”´ Redis ì„¤ì • (ì„¸ì…˜/ìºì‹œìš©)
  # =============================================================================
  redis-max-memory: "256mb"
  redis-eviction-policy: "allkeys-lru"
  redis-save-interval: "900 1 300 10 60 10000"
  redis-append-only: "yes"
  redis-append-fsync: "everysec"
  
  # Redis ìµœì í™” ì„¤ì •
  redis-tcp-keepalive: "300"
  redis-timeout: "0"
  redis-tcp-backlog: "511"
  redis-databases: "16"
  
  # Redis ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸
  redis-init-script: |
    # Redis ì„¤ì • íŒŒì¼
    maxmemory ${redis-max-memory}
    maxmemory-policy ${redis-eviction-policy}
    save ${redis-save-interval}
    appendonly ${redis-append-only}
    appendfsync ${redis-append-fsync}
    tcp-keepalive ${redis-tcp-keepalive}
    timeout ${redis-timeout}
    tcp-backlog ${redis-tcp-backlog}
    databases ${redis-databases}

  # =============================================================================
  # ğŸ“¡ Kafka ì„¤ì • (ë©”ì‹œì§•ìš©)
  # =============================================================================
  kafka-brokers: "kafka-service:9092"
  kafka-zookeeper-connect: "zookeeper-service:2181"
  kafka-topics: "notifications,events,user-activity,post-updates"
  
  # Kafka í† í”½ ì„¤ì •
  kafka-topic-notifications: "notifications"
  kafka-topic-events: "events"
  kafka-topic-user-activity: "user-activity"
  kafka-topic-post-updates: "post-updates"
  
  # Kafka ìµœì í™” ì„¤ì •
  kafka-partitions-per-topic: "3"
  kafka-replication-factor: "1"
  kafka-retention-hours: "168"  # 7ì¼
  kafka-segment-bytes: "1073741824"  # 1GB
  kafka-log-retention-check-interval-ms: "300000"
  
  # Kafka í† í”½ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
  kafka-topics-script: |
    #!/bin/bash
    
    # í† í”½ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
    TOPICS=("notifications" "events" "user-activity" "post-updates")
    PARTITIONS=3
    REPLICATION_FACTOR=1
    
    for topic in "${TOPICS[@]}"; do
      kafka-topics.sh --create \
        --topic $topic \
        --bootstrap-server kafka-service:9092 \
        --partitions $PARTITIONS \
        --replication-factor $REPLICATION_FACTOR \
        --if-not-exists
      echo "Topic '$topic' created successfully"
    done
    
    # í† í”½ ëª©ë¡ í™•ì¸
    kafka-topics.sh --list --bootstrap-server kafka-service:9092

  # =============================================================================
  # ğŸŒ ê³µí†µ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì •
  # =============================================================================
  # ì—°ê²° íƒ€ì„ì•„ì›ƒ ì„¤ì •
  connection-timeout: "30"
  max-connections: "100"
  connection-retry-attempts: "3"
  connection-retry-delay: "1000"
  
  # í’€ë§ ì„¤ì •
  pool-size-min: "5"
  pool-size-max: "20"
  pool-validation-timeout: "3000"
  pool-idle-timeout: "600000"
  
  # Health Check ì„¤ì •
  health-check-interval: "30000"
  health-check-timeout: "5000"
  health-check-retries: "3"

# =============================================================================
# ğŸ” ì„¤ëª… ë° ì‚¬ìš©ë²•
# =============================================================================
# 
# ì´ ConfigMap ì‚¬ìš© ë°©ë²•:
# 1. ë°ì´í„°ë² ì´ìŠ¤ Podì— í™˜ê²½ ë³€ìˆ˜ë¡œ ì£¼ì…:
#    envFrom:
#      - configMapRef:
#          name: database-config
#
# 2. Init Containerì—ì„œ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©:
#    initContainers:
#      - name: init-db
#        image: mysql:8.0
#        command: ["/bin/bash", "-c"]
#        args:
#          - |
#            mysql -h $MYSQL_HOST -u root -p$MYSQL_ROOT_PASSWORD -e "$(cat /etc/mysql/init/init.sql)"
#        volumeMounts:
#          - name: mysql-init-script
#            mountPath: /etc/mysql/init/init.sql
#            subPath: mysql-init-script
#        envFrom:
#          - configMapRef:
#              name: database-config
#
# 3. Kubernetes Jobìœ¼ë¡œ ì´ˆê¸°í™” ì‘ì—… ì‹¤í–‰:
#    apiVersion: batch/v1
#    kind: Job
#    metadata:
#      name: database-init
#    spec:
#      template:
#        spec:
#          containers:
#          - name: init-mongodb
#            image: mongo:6.0
#            command: ["mongosh"]
#            args: ["--eval", "$(cat /etc/mongodb/init.js)"]
#            volumeMounts:
#              - name: mongodb-init-script
#                mountPath: /etc/mongodb/init.js
#                subPath: mongodb-init-script
#          volumes:
#            - name: mongodb-init-script
#              configMap:
#                name: database-config
#
# ì‹¤ë¬´ íŒ:
# - ë°ì´í„°ë² ì´ìŠ¤ ë²„ì „ë³„ë¡œ ë‹¤ë¥¸ ConfigMap ì‚¬ìš©
# - ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì„±ëŠ¥ íŠœë‹ ê°’ ì¡°ì • í•„ìš”
# - ë°±ì—… ë° ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸ë„ ConfigMapì— í¬í•¨ ê°€ëŠ¥
# - ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì„¤ì •ë„ í•¨ê»˜ ê´€ë¦¬
# =============================================================================