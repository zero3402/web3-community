# =============================================================================
# ğŸŒ Ingress ì„¤ì • (ì™¸ë¶€ ì ‘ê·¼)
# =============================================================================
# ğŸ“ ì„¤ëª…: í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ì†ì„ ìœ„í•œ Ingress ì„¤ì •
# ğŸ¯ ëª©ì : HTTPS termination, Load Balancing, URL routing
# ğŸŒŸ ì‹¤ë¬´ íŒ: SSL/TLS ì„¤ì •, Rate Limiting, Security Headers í•„ìˆ˜
# âš ï¸  ì£¼ì˜: Ingress Controllerê°€ ì‚¬ì „ì— ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #6-1 (ëª¨ë“  ì„œë¹„ìŠ¤ ë°°í¬ í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://kubernetes.io/docs/concepts/services-networking/ingress/
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress

metadata:
  name: web3-community-ingress   # Ingress ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: ingress
    tier: networking
    environment: local
  
  annotations:
    description: "Main ingress for web3-community platform"
    created-by: "developer"
    
    # =============================================================================
    # ğŸ›¡ï¸ NGINX Ingress Controller ì„¤ì •
    # =============================================================================
    # Ingress Controller ì¢…ë¥˜
    kubernetes.io/ingress.class: "nginx"
    
    # ë¦¬ë¼ì´íŠ¸ ì„¤ì • (URL ì •ë¦¬)
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/use-regex: "true"
    
    # SSL/TLS ì„¤ì • (ë¡œì»¬ ê°œë°œì—ì„œëŠ” ë¹„í™œì„±í™”)
    # nginx.ingress.kubernetes.io/ssl-redirect: "false"
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # ë³´ì•ˆ í—¤ë” ì„¤ì •
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self';"
    
    # CORS ì„¤ì •
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    
    # ë¦¬ë¯¸íŠ¸ ì„¤ì • (DDoS ë°©ì§€)
    nginx.ingress.kubernetes.io/limit-connections: "100"
    nginx.ingress.kubernetes.io/limit-rps: "50"
    
    # í”„ë¡ì‹œ ì„¤ì •
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "4k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    
    # íƒ€ì„ì•„ì›ƒ ì„¤ì •
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "30"
    
    # WebSocket ì§€ì›
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "3600"

spec:
  # =============================================================================
  # ğŸ”„ TLS ì„¤ì • (HTTPS)
  # =============================================================================
  # ë¡œì»¬ ê°œë°œì—ì„œëŠ” TLS ë¹„í™œì„±í™” (ìš´ì˜ í™˜ê²½ì—ì„œëŠ” í•„ìˆ˜)
  # tls:
  # - hosts:
  #   - web3-community.local
  #   secretName: web3-community-tls-secret
  
  # =============================================================================
  # ğŸ“¡ ë¼ìš°íŒ… ê·œì¹™
  # =============================================================================
  rules:
  # =============================================================================
  # ğŸ¨ Frontend (Vue.js)
  # =============================================================================
  - host: web3-community.local   # ë¡œì»¬ ê°œë°œ ë„ë©”ì¸
    http:
      paths:
      - path: /                   # ê¸°ë³¸ ê²½ë¡œëŠ” í”„ë¡ íŠ¸ì—”ë“œ
        pathType: Prefix
        backend:
          service:
            name: frontend-service  # í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ (ì•„ë˜ì— ì •ì˜)
            port:
              number: 80
  
  # =============================================================================
  # ğŸš€ Backend API Gateway
  # =============================================================================
  - host: web3-community.local
    http:
      paths:
      - path: /api(/|$)(.*)        # /api/* ê²½ë¡œëŠ” ë°±ì—”ë“œ API
        pathType: Prefix
        backend:
          service:
            name: api-gateway-service
            port:
              number: 8080
  
  # =============================================================================
  # ğŸŒ ì¶”ê°€ ë„ë©”ì¸ ì„¤ì • (ìš´ìš© í™˜ê²½ìš©)
  # =============================================================================
  # - host: api.web3-community.local   # API ì „ìš© ë„ë©”ì¸
  #   http:
  #     paths:
  #     - path: /
  #       pathType: Prefix
  #       backend:
  #         service:
  #           name: api-gateway-service
  #           port:
  #             number: 8080

---

# =============================================================================
# ğŸ¨ Frontend ì„œë¹„ìŠ¤ (Ingress ì—°ë™ìš©)
# =============================================================================
apiVersion: v1
kind: Service

metadata:
  name: frontend-service          # í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: frontend
    tier: presentation
    service-type: frontend
    environment: local
  
  annotations:
    description: "Frontend service for ingress routing"
    created-by: "developer"

spec:
  type: ClusterIP                 # Ingressì—ì„œë§Œ ì ‘ê·¼
  
  selector:
    app: frontend
    component: frontend
    tier: presentation
  
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 80

---

# =============================================================================
# ğŸ›¡ï¸ Network Policy (ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ)
# =============================================================================
# ğŸ“ ì„¤ëª…: í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ ì œì–´ ì •ì±…
# ğŸ¯ ëª©ì : ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ ì°¨ë‹¨, ë³´ì•ˆ ê°•í™”
# ğŸŒŸ ì‹¤ë¬´ íŒ: ìµœì†Œ ê¶Œí•œ ì›ì¹™ìœ¼ë¡œ í•„ìš”í•œ í†µì‹ ë§Œ í—ˆìš©
# âš ï¸  ì£¼ì˜: NetworkPolicyê°€ ì ìš©ë˜ë ¤ë©´ CNI í”ŒëŸ¬ê·¸ì¸ í•„ìš”
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #6-2 (Ingress ì„¤ì • í›„ ì‹¤í–‰)
# =============================================================================

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy

metadata:
  name: web3-community-network-policy
  namespace: web3-community     # ë„¤ì„ìŠ¤í˜ì´ì§€ ë‹¨ìœ„ ì •ì±…
  
  labels:
    app: web3-community
    component: network-policy
    tier: security
    environment: local
  
  annotations:
    description: "Network security policy for web3-community"
    created-by: "developer"

spec:
  # =============================================================================
  # ğŸ¯ ì •ì±… ì ìš© ëŒ€ìƒ (Pod Selector)
  # =============================================================================
  podSelector: {}                 # ë„¤ì„ìŠ¤í˜ì´ì§€ ë‚´ ëª¨ë“  Podì— ì ìš©
  
  # =============================================================================
  # ğŸ“¤ Egress ê·œì¹™ (ì™¸ë¶€ ë‚˜ê°€ëŠ” íŠ¸ë˜í”½)
  # =============================================================================
  policyTypes:
  - Ingress
  - Egress
  
  egress:
  # DNS ì¡°íšŒ í—ˆìš©
  - to: []
    ports:
    - protocol: UDP
      port: 53
  
  # Kubernetes API ì„œë²„ ì ‘ì† í—ˆìš©
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 443
  
  # =============================================================================
  # ğŸ“¥ Ingress ê·œì¹™ (ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½)
  # =============================================================================
  ingress:
  # Ingress Controllerì—ì„œì˜ ì ‘ì† í—ˆìš©
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 8081
    - protocol: TCP
      port: 8082
    - protocol: TCP
      port: 8083
    - protocol: TCP
      port: 8084
    - protocol: TCP
      port: 8085
  
  # ë™ì¼ ë„¤ì„ìŠ¤í˜ì´ì§€ ë‚´ë¶€ í†µì‹  í—ˆìš©
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 8081
    - protocol: TCP
      port: 8082
    - protocol: TCP
      port: 8083
    - protocol: TCP
      port: 8084
    - protocol: TCP
      port: 8085
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 27017
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 9092
    - protocol: TCP
      port: 2181

# =============================================================================
# ğŸŒŸ Ingress ê´€ë¦¬ ëª…ë ¹ì–´
# =============================================================================
# 
# Ingress ìƒíƒœ í™•ì¸:
# kubectl get ingress web3-community-ingress -n web3-community
# kubectl describe ingress web3-community-ingress -n web3-community
#
# Ingress IP/Port í™•ì¸:
# kubectl get ingress web3-community-ingress -n web3-community -o wide
#
# ë¡œì»¬ DNS ì„¤ì • (/etc/hosts):
# echo "127.0.0.1 web3-community.local" | sudo tee -a /etc/hosts
#
# ì ‘ì† í…ŒìŠ¤íŠ¸:
# curl -I http://web3-community.local
# curl -I http://web3-community.local/api/health
#
# Ingress Controller ë¡œê·¸ í™•ì¸:
# kubectl logs -n ingress-nginx deployment/ingress-nginx-controller
#
# NetworkPolicy ìƒíƒœ í™•ì¸:
# kubectl get networkpolicy -n web3-community
# kubectl describe networkpolicy web3-community-network-policy -n web3-community
#
# SSL/TLS ì¸ì¦ì„œ ìƒíƒœ:
# kubectl get certificates -n web3-community
# kubectl describe certificate web3-community-tls-secret -n web3-community
#
# ì‹¤ë¬´ íŒ:
# - ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ë¬´ì¡°ê±´ HTTPS ì ìš©
# - Rate Limiting ì„¤ì •ìœ¼ë¡œ DDoS ë°©ì–´
# - Web Application Firewall (WAF) ì ìš©
# - CDN ì—°ë™ìœ¼ë¡œ ì „ ì„¸ê³„ ì„±ëŠ¥ ìµœì í™”
# - ëª¨ë‹ˆí„°ë§: Ingress ì ‘ì† ë¡œê·¸ ë° ë©”íŠ¸ë¦­ ìˆ˜ì§‘
# =============================================================================