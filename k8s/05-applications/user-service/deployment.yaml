# =============================================================================
# ğŸ‘¤ User Service ë°°í¬ (ì‚¬ìš©ì ê´€ë¦¬)
# =============================================================================
# ğŸ“ ì„¤ëª…: ì‚¬ìš©ì CRUD, ì¸ì¦, ê¶Œí•œ ê´€ë¦¬ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤
# ğŸ¯ ëª©ì : ì‚¬ìš©ì ì •ë³´ ê´€ë¦¬, íšŒì›ê°€ì…, ë¡œê·¸ì¸, í”„ë¡œí•„ ê´€ë¦¬
# ğŸŒŸ ì‹¤ë¬´ íŒ: ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”, ê¶Œí•œ ì²´ê³„, OAuth2 ì—°ë™ ì¤‘ìš”
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #5-2 (API Gateway ì‹¤í–‰ í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://spring.io/projects/spring-boot
# =============================================================================

apiVersion: apps/v1
kind: Deployment

metadata:
  name: user-service-deployment   # ë°°í¬ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: user-service
    tier: backend
    environment: local
    deployment-type: microservice
  
  annotations:
    description: "User management microservice"
    created-by: "developer"
    deployment-version: "v1.0"

spec:
  replicas: 2
  
  selector:
    matchLabels:
      app: user-service
      component: user-service
      tier: backend
  
  template:
    metadata:
      labels:
        app: user-service
        component: user-service
        tier: backend
        environment: local
        pod-template-hash: "auto-generated"
      
      annotations:
        description: "User Service pod"
        created-by: "developer"
        restart-policy: "Always"
    
    spec:
      containers:
      - name: user-service
        image: web3-community/user-service:latest
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: http
          containerPort: 8081
          protocol: TCP
        
        env:
        - name: SPRING_PROFILES_ACTIVE
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: spring.profiles.active
        
        # MySQL ì—°ê²° ì •ë³´
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:mysql://mysql-service:3306/web3_community"
        
        - name: SPRING_DATASOURCE_USERNAME
          value: "web3user"
        
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: mysql-password
        
        # JWT ì„¤ì •
        - name: USER_SERVICE_JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secrets
              key: jwt-access-secret
        
        - name: USER_SERVICE_JWT_EXPIRATION
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: user.service.jwt.expiration
        
        # ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™” í‚¤
        - name: PASSWORD_ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: jwt-secrets
              key: encryption-key
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "768Mi"
            cpu: "500m"

---

apiVersion: v1
kind: Service

metadata:
  name: user-service-service      # ì„œë¹„ìŠ¤ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: user-service
    tier: backend
    service-type: microservice
    environment: local
  
  annotations:
    description: "User Service endpoint"
    created-by: "developer"

spec:
  type: ClusterIP
  
  selector:
    app: user-service
    component: user-service
    tier: backend
  
  ports:
    - name: http
      protocol: TCP
      port: 8081
      targetPort: 8081

---

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler

metadata:
  name: user-service-hpa          # HPA ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: user-service
    autoscaler-type: hpa
    environment: local
  
  annotations:
    description: "Horizontal Pod Autoscaler for User Service"
    created-by: "developer"

spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: user-service-deployment
  
  minReplicas: 2
  maxReplicas: 8
  
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80