# =============================================================================
# ğŸš€ API Gateway ë°°í¬ (Spring Cloud Gateway)
# =============================================================================
# ğŸ“ ì„¤ëª…: ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì˜ ë‹¨ì¼ ì§„ì…ì , ë¼ìš°íŒ…, ë¡œë“œë°¸ëŸ°ì‹±
# ğŸ¯ ëª©ì : API Gateway, ì¸ì¦/ì¸ê°€, ë¼ìš°íŒ…, ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬
# ğŸŒŸ ì‹¤ë¬´ íŒ: Circuit Breaker, Rate Limiting, Security í•„ìˆ˜ êµ¬ì„±
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #5-1 (ë°ì´í„°ë² ì´ìŠ¤ ì‹¤í–‰ í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://spring.io/projects/spring-cloud-gateway
# =============================================================================

apiVersion: apps/v1
kind: Deployment

metadata:
  name: api-gateway-deployment   # ë°°í¬ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ìŠ¤
  
  labels:
    app: web3-community
    component: api-gateway
    tier: frontend
    environment: local
    deployment-type: gateway
  
  annotations:
    description: "Spring Cloud Gateway for microservices routing"
    created-by: "developer"
    deployment-version: "v1.0"

spec:
  replicas: 2                      # ê³ ê°€ìš©ì„±ì„ ìœ„í•´ 2ê°œ ë³µì œë³¸
  
  selector:
    matchLabels:
      app: api-gateway
      component: api-gateway
      tier: frontend
  
  template:
    metadata:
      labels:
        app: api-gateway
        component: api-gateway
        tier: frontend
        environment: local
        pod-template-hash: "auto-generated"
      
      annotations:
        description: "API Gateway pod"
        created-by: "developer"
        restart-policy: "Always"
    
    spec:
      containers:
      - name: api-gateway
        image: web3-community/api-gateway:latest  # ì§ì ‘ ë¹Œë“œí•œ ì´ë¯¸ì§€
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        
        - name: actuator
          containerPort: 8081
          protocol: TCP
        
        env:
        # Spring Boot ì„¤ì •
        - name: SPRING_PROFILES_ACTIVE
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: spring.profiles.active
        
        # JWT ì„¤ì • (Secretì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secrets
              key: jwt-access-secret
        
        - name: JWT_EXPIRATION
          valueFrom:
            secretKeyRef:
              name: jwt-secrets
              key: jwt-access-expiration
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´ (User Serviceìš©)
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:mysql://mysql-service:3306/web3_community"
        
        - name: SPRING_DATASOURCE_USERNAME
          value: "web3user"
        
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: mysql-password
        
        # Redis ì„¤ì • (ì„¸ì…˜ ê´€ë¦¬ìš©)
        - name: SPRING_REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: redis.host
        
        - name: SPRING_REDIS_PORT
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: redis.port
        
        - name: SPRING_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: redis-password
        
        # CORS ì„¤ì •
        - name: CORS_ALLOWED_ORIGINS
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: cors.allowed.origins
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---

# =============================================================================
# ğŸŒ API Gateway ì„œë¹„ìŠ¤ ì •ì˜
# =============================================================================
apiVersion: v1
kind: Service

metadata:
  name: api-gateway-service       # ì„œë¹„ìŠ¤ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: api-gateway
    tier: frontend
    service-type: gateway
    environment: local
  
  annotations:
    description: "API Gateway service endpoint"
    created-by: "developer"

spec:
  type: ClusterIP                 # í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ì ‘ì†
  
  selector:
    app: api-gateway
    component: api-gateway
    tier: frontend
  
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080
    
    - name: actuator
      protocol: TCP
      port: 8081
      targetPort: 8081

---

# =============================================================================
# ğŸ“Š API Gateway HPA (Horizontal Pod Autoscaler)
# =============================================================================
# ğŸ“ ì„¤ëª…: API Gatewayì˜ ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì •
# ğŸ¯ ëª©ì : íŠ¸ë˜í”½ì— ë”°ë¥¸ ìë™ í™•ì¥ìœ¼ë¡œ ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤ ì œê³µ
# ğŸŒŸ ì‹¤ë¬´ íŒ: CPU ì‚¬ìš©ëŸ‰ ì™¸ì— ì»¤ìŠ¤í…€ ë©”íŠ¸ë¦­ ì¶”ê°€ ê°€ëŠ¥
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #5-2 (ì„œë¹„ìŠ¤ ë°°í¬ í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/
# =============================================================================

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler

metadata:
  name: api-gateway-hpa          # HPA ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: api-gateway
    autoscaler-type: hpa
    environment: local
  
  annotations:
    description: "Horizontal Pod Autoscaler for API Gateway"
    created-by: "developer"

spec:
  # =============================================================================
  # ğŸ¯ ìŠ¤ì¼€ì¼ë§ ëŒ€ìƒ
  # =============================================================================
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-gateway-deployment   # í™•ì¥í•  ë°°í¬
  
  # =============================================================================
  # ğŸ“Š ìŠ¤ì¼€ì¼ë§ ì„¤ì •
  # =============================================================================
  minReplicas: 2                  # ìµœì†Œ ë³µì œë³¸ ìˆ˜
  maxReplicas: 10                 # ìµœëŒ€ ë³µì œë³¸ ìˆ˜
  
  # =============================================================================
  # ğŸ“ˆ ë©”íŠ¸ë¦­ ê¸°ë°˜ ìŠ¤ì¼€ì¼ë§
  # =============================================================================
  metrics:
  # CPU ì‚¬ìš©ë¥  ê¸°ë°˜ ìŠ¤ì¼€ì¼ë§
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70     # CPU ì‚¬ìš©ë¥  70% ì´ˆê³¼ ì‹œ í™•ì¥
  
  # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  ê¸°ë°˜ ìŠ¤ì¼€ì¼ë§
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80     # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  80% ì´ˆê³¼ ì‹œ í™•ì¥

# =============================================================================
# ğŸŒŸ API Gateway ê´€ë¦¬ ëª…ë ¹ì–´
# =============================================================================
# 
# ë°°í¬ ìƒíƒœ í™•ì¸:
# kubectl get deployment api-gateway-deployment -n web3-community
# kubectl get pods -l app=api-gateway -n web3-community
#
# ì„œë¹„ìŠ¤ ì ‘ì† í…ŒìŠ¤íŠ¸:
# kubectl run gateway-test --image=curlimages/curl --rm -it --restart=Never \
#   -- curl -X GET http://api-gateway-service:8080/actuator/health
#
# ë¼ìš°íŒ… í…ŒìŠ¤íŠ¸:
# kubectl run gateway-test --image=curlimages/curl --rm -it --restart=Never \
#   -- curl -X GET http://api-gateway-service:8080/api/users/health
#
# HPA ìƒíƒœ í™•ì¸:
# kubectl get hpa api-gateway-hpa -n web3-community
# kubectl describe hpa api-gateway-hpa -n web3-community
#
# ìŠ¤ì¼€ì¼ë§ í…ŒìŠ¤íŠ¸:
# kubectl scale deployment api-gateway-deployment --replicas=5 -n web3-community
#
# ë¡œê·¸ í™•ì¸:
# kubectl logs deployment/api-gateway-deployment -n web3-community -f
#
# Gateway ë¼ìš°íŠ¸ í™•ì¸:
# kubectl exec deployment/api-gateway-deployment -n web3-community -- \
#   curl -X GET http://localhost:8080/actuator/gateway/routes
#
# ì‹¤ë¬´ íŒ:
# - Circuit Breaker ì„¤ì •ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì¥ì•  ê²©ë¦¬
# - Rate Limitingìœ¼ë¡œ íŠ¸ë˜í”½ ì œì–´
# - JWT í•„í„°ë¡œ ì¸ì¦/ì¸ê°€ ì²˜ë¦¬
# - Request/Response ë¡œê¹…ìœ¼ë¡œ ë””ë²„ê¹… ìš©ì´
# - ëª¨ë‹ˆí„°ë§: Spring Boot Actuator + Prometheus
# =============================================================================