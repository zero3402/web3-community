# =============================================================================
# ğŸ“ Post Service, Comment Service, Auth Service, Notification Service ë°°í¬
# =============================================================================
# ğŸ“ ì„¤ëª…: ë‚˜ë¨¸ì§€ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë“¤ì˜ ë°°í¬ ì„¤ì • (íŒŒì¼ í•˜ë‚˜ë¡œ í†µí•©)
# ğŸ¯ ëª©ì : ê²Œì‹œê¸€, ëŒ“ê¸€, ì¸ì¦, ì•Œë¦¼ ê¸°ëŠ¥ ì œê³µ
# ğŸŒŸ ì‹¤ë¬´ íŒ: ê° ì„œë¹„ìŠ¤ì˜ íŠ¹ì„±ì— ë§ëŠ” ì„¤ì •ê³¼ ë¦¬ì†ŒìŠ¤ í• ë‹¹
# ğŸ”„ ì‹¤í–‰ ìˆœì„œ: #5-3 (User Service ì‹¤í–‰ í›„ ì‹¤í–‰)
# ğŸ“– ì°¸ê³ : https://spring.io/projects/spring-boot
# =============================================================================

# =============================================================================
# ğŸ“ Post Service ë°°í¬ (ê²Œì‹œê¸€ ê´€ë¦¬)
# =============================================================================
apiVersion: apps/v1
kind: Deployment

metadata:
  name: post-service-deployment   # ë°°í¬ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: post-service
    tier: backend
    environment: local
    deployment-type: microservice

spec:
  replicas: 2
  
  selector:
    matchLabels:
      app: post-service
      component: post-service
      tier: backend
  
  template:
    metadata:
      labels:
        app: post-service
        component: post-service
        tier: backend
        environment: local
      
      annotations:
        description: "Post Service pod"
        created-by: "developer"
    
    spec:
      containers:
      - name: post-service
        image: web3-community/post-service:latest
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: http
          containerPort: 8082
          protocol: TCP
        
        env:
        - name: SPRING_PROFILES_ACTIVE
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: spring.profiles.active
        
        # MongoDB ì—°ê²° ì •ë³´
        - name: SPRING_DATA_MONGODB_URI
          value: "mongodb://mongouser:mongopass@mongodb-service:27017/web3_posts"
        
        - name: SPRING_DATA_MONGODB_DATABASE
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: mongodb-database.name
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8082
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8082
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---

apiVersion: v1
kind: Service

metadata:
  name: post-service-service      # ì„œë¹„ìŠ¤ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: post-service
    tier: backend
    service-type: microservice

spec:
  type: ClusterIP
  
  selector:
    app: post-service
    component: post-service
    tier: backend
  
  ports:
    - name: http
      protocol: TCP
      port: 8082
      targetPort: 8082

---

# =============================================================================
# ğŸ’¬ Comment Service ë°°í¬ (ëŒ“ê¸€ ê´€ë¦¬)
# =============================================================================
apiVersion: apps/v1
kind: Deployment

metadata:
  name: comment-service-deployment
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: comment-service
    tier: backend
    environment: local
    deployment-type: microservice

spec:
  replicas: 2
  
  selector:
    matchLabels:
      app: comment-service
      component: comment-service
      tier: backend
  
  template:
    metadata:
      labels:
        app: comment-service
        component: comment-service
        tier: backend
        environment: local
      
      annotations:
        description: "Comment Service pod"
        created-by: "developer"
    
    spec:
      containers:
      - name: comment-service
        image: web3-community/comment-service:latest
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: http
          containerPort: 8083
          protocol: TCP
        
        env:
        - name: SPRING_PROFILES_ACTIVE
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: spring.profiles.active
        
        # MongoDB ì—°ê²° ì •ë³´
        - name: SPRING_DATA_MONGODB_URI
          value: "mongodb://mongouser:mongopass@mongodb-service:27017/web3_posts"
        
        - name: SPRING_DATA_MONGODB_DATABASE
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: mongodb-database.name
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8083
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8083
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---

apiVersion: v1
kind: Service

metadata:
  name: comment-service-service   # ì„œë¹„ìŠ¤ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: comment-service
    tier: backend
    service-type: microservice

spec:
  type: ClusterIP
  
  selector:
    app: comment-service
    component: comment-service
    tier: backend
  
  ports:
    - name: http
      protocol: TCP
      port: 8083
      targetPort: 8083

---

# =============================================================================
# ğŸ” Auth Service ë°°í¬ (ì¸ì¦/ì¸ê°€)
# =============================================================================
apiVersion: apps/v1
kind: Deployment

metadata:
  name: auth-service-deployment
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: auth-service
    tier: backend
    environment: local
    deployment-type: microservice

spec:
  replicas: 2
  
  selector:
    matchLabels:
      app: auth-service
      component: auth-service
      tier: backend
  
  template:
    metadata:
      labels:
        app: auth-service
        component: auth-service
        tier: backend
        environment: local
      
      annotations:
        description: "Auth Service pod"
        created-by: "developer"
    
    spec:
      containers:
      - name: auth-service
        image: web3-community/auth-service:latest
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: http
          containerPort: 8084
          protocol: TCP
        
        env:
        - name: SPRING_PROFILES_ACTIVE
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: spring.profiles.active
        
        # Redis ì—°ê²° ì •ë³´ (ì„¸ì…˜ ê´€ë¦¬)
        - name: SPRING_REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: redis.host
        
        - name: SPRING_REDIS_PORT
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: redis.port
        
        - name: SPRING_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: database-secrets
              key: redis-password
        
        # JWT ì„¤ì •
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: jwt-secrets
              key: jwt-access-secret
        
        - name: JWT_EXPIRATION
          valueFrom:
            secretKeyRef:
              name: jwt-secrets
              key: jwt-access-expiration
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8084
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8084
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "128Mi"
            cpu: "150m"
          limits:
            memory: "256Mi"
            cpu: "300m"

---

apiVersion: v1
kind: Service

metadata:
  name: auth-service-service      # ì„œë¹„ìŠ¤ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: auth-service
    tier: backend
    service-type: microservice

spec:
  type: ClusterIP
  
  selector:
    app: auth-service
    component: auth-service
    tier: backend
  
  ports:
    - name: http
      protocol: TCP
      port: 8084
      targetPort: 8084

---

# =============================================================================
# ğŸ”” Notification Service ë°°í¬ (ì•Œë¦¼)
# =============================================================================
apiVersion: apps/v1
kind: Deployment

metadata:
  name: notification-service-deployment
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: notification-service
    tier: backend
    environment: local
    deployment-type: microservice

spec:
  replicas: 2
  
  selector:
    matchLabels:
      app: notification-service
      component: notification-service
      tier: backend
  
  template:
    metadata:
      labels:
        app: notification-service
        component: notification-service
        tier: backend
        environment: local
      
      annotations:
        description: "Notification Service pod"
        created-by: "developer"
    
    spec:
      containers:
      - name: notification-service
        image: web3-community/notification-service:latest
        imagePullPolicy: IfNotPresent
        
        ports:
        - name: http
          containerPort: 8085
          protocol: TCP
        
        env:
        - name: SPRING_PROFILES_ACTIVE
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: spring.profiles.active
        
        # Kafka ì—°ê²° ì •ë³´
        - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: kafka.bootstrap.servers
        
        - name: KAFKA_TOPICS
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: notification.service.kafka.topics
        
        - name: KAFKA_CONSUMER_GROUP_ID
          valueFrom:
            configMapKeyRef:
              name: backend-config
              key: notification.service.consumer.group.id
        
        # =============================================================================
        # ğŸ¥ í—¬ìŠ¤ì²´í¬
        # =============================================================================
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8085
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
        
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8085
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 2
          successThreshold: 1
        
        # =============================================================================
        # ğŸ’¾ ë¦¬ì†ŒìŠ¤ ê´€ë¦¬
        # =============================================================================
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---

apiVersion: v1
kind: Service

metadata:
  name: notification-service-service  # ì„œë¹„ìŠ¤ ì´ë¦„
  namespace: web3-community     # ì†Œì† ë„¤ì„ìŠ¤í˜ì´ì§€
  
  labels:
    app: web3-community
    component: notification-service
    tier: backend
    service-type: microservice

spec:
  type: ClusterIP
  
  selector:
    app: notification-service
    component: notification-service
    tier: backend
  
  ports:
    - name: http
      protocol: TCP
      port: 8085
      targetPort: 8085

# =============================================================================
# ğŸŒŸ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê´€ë¦¬ ëª…ë ¹ì–´
# =============================================================================
# 
# ì „ì²´ ë°°í¬ ìƒíƒœ í™•ì¸:
# kubectl get deployments -n web3-community -l deployment-type=microservice
# kubectl get pods -n web3-community -l deployment-type=microservice
#
# ì„œë¹„ìŠ¤ ëª©ë¡ í™•ì¸:
# kubectl get svc -n web3-community -l service-type=microservice
#
# ê° ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬:
# kubectl exec deployment/post-service-deployment -n web3-community -- \
#   curl -X GET http://localhost:8082/actuator/health
#
# Kafka í† í”½ ìƒì„± (Notification Serviceìš©):
# kubectl exec deployment/kafka-deployment -n web3-community -- \
#   kafka-topics --bootstrap-server localhost:9092 \
#   --create --topic notifications --partitions 3 --replication-factor 1
#
# MongoDB ì»¬ë ‰ì…˜ í™•ì¸:
# kubectl exec deployment/mongodb-deployment -n web3-community -- \
#   mongosh --eval "use web3_posts; show collections"
#
# ì‹¤ë¬´ íŒ:
# - ê° ì„œë¹„ìŠ¤ë³„ë¡œ ì ì ˆí•œ ë¦¬ì†ŒìŠ¤ í• ë‹¹
# - ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì€ Service Discovery ì‚¬ìš©
# - Circuit Breakerë¡œ ì„œë¹„ìŠ¤ ì¥ì•  ê²©ë¦¬
# - ë¶„ì‚° ì¶”ì ì„ ìœ„í•œ Correlation ID ì „íŒŒ
# - ê° ì„œë¹„ìŠ¤ë³„ ë…ë¦½ì ì¸ ëª¨ë‹ˆí„°ë§ ì„¤ì •
# =============================================================================