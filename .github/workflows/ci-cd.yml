name: CI/CD Pipeline for Web3 Community

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # =============================================================================
  # ğŸ§ª í…ŒìŠ¤íŠ¸ ë° ì½”ë“œ í’ˆì§ˆ ê²€ì¦
  # =============================================================================
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready -U testuser -d testdb
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio pytest-cov

      - name: ì½”ë“œ ìŠ¤íƒ€ì¼ë§ ê²€ì¦
        run: |
          cd backend
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-for-ci-cd
          TESTING: true
        run: |
          cd backend
          pytest tests/ -v --cov=app --cov-report=xml

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage.xml
          flags: unittests
          name: codecov-umbrella

  # =============================================================================
  # ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  # =============================================================================
  frontend-test:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: ./frontend
        run: npm ci

      - name: í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
        working-directory: ./frontend
        run: npm run test

      - name: ë¹Œë“œ í™•ì¸
        working-directory: ./frontend
        run: npm run build

  # =============================================================================
  # ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ
  # =============================================================================
  build:
    needs: [test, frontend-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        service: [user-service, post-service, comment-service, notification-service, analytics-service, auth-service]

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./backend/${{ matrix.service }}
          file: ./backend/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            web3community/${{ matrix.service }}:latest
            web3community/${{ matrix.service }}:${{ github.sha }}

  # =============================================================================
  # ğŸ³ í”„ë¡ íŠ¸ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ
  # =============================================================================
  build-frontend:
    needs: [frontend-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: í”„ë¡ íŠ¸ì—”ë“œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            web3community/frontend:latest
            web3community/frontend:${{ github.sha }}

  # =============================================================================
  # ğŸš€ ë°°í¬ (ê°œë°œ í™˜ê²½)
  # =============================================================================
  deploy-staging:
    needs: [build, build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          chmod +x ./scripts/deploy-staging.sh
          ./scripts/deploy-staging.sh
        env:
          STAGING_SERVER: ${{ secrets.STAGING_SERVER }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_KEY: ${{ secrets.STAGING_KEY }}

      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          curl -f http://staging.web3community.com/health || exit 1
        if: always()

  # =============================================================================
  # ğŸš€ ë°°í¬ (ìš´ì˜ í™˜ê²½)
  # =============================================================================
  deploy-production:
    needs: [build, build-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: íƒœê·¸ ìƒì„±
        run: |
          export VERSION=$(git describe --tags --always)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: íƒœê·¸ëœ ì´ë¯¸ì§€ í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: ./backend/user-service
          push: false
          tags: |
            web3community/user-service:${{ env.VERSION }}
        env:
          VERSION: ${{ env.VERSION }}

      - name: ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          chmod +x ./scripts/deploy-production.sh
          ./scripts/deploy-production.sh ${{ env.VERSION }}
        env:
          VERSION: ${{ env.VERSION }}
          PROD_SERVER: ${{ secrets.PROD_SERVER }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_KEY: ${{ secrets.PROD_KEY }}

      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          curl -f https://api.web3community.com/health || exit 1
        if: always()

  # =============================================================================
  # ğŸ” ë³´ì•ˆ ìŠ¤ìº”
  # =============================================================================
  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Trivy ìŠ¤ìº”
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Trivy ê²°ê³¼ ì—…ë¡œë“œ
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # =============================================================================
  # ğŸ“Š ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  # =============================================================================
  performance-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker ì»´í¬ì¦ˆ ì‹¤í–‰
        run: |
          docker-compose -f docker-compose.yml up -d
          sleep 30

      - name: Apache Bench ì‹¤í–‰
        run: |
          docker run --rm --network web3community_default -t http://api:8080 http://nginx:80 ab -n 1000 -c 10 http://nginx/

      - name: K6 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          docker run --rm --network web3community_default -t http://api:8080 \
            -v $(pwd)/tests/performance:/tests \
            grafana/k6 run /tests/load-test.js

      - name: ì»´í¬ì¦ˆ ì¤‘ì§€
        run: |
          docker-compose -f docker-compose.yml down

  # =============================================================================
  # ğŸ“Š ì •ì  ë¶„ì„
  # =============================================================================
  sonarcloud:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud ìŠ¤ìº”
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # =============================================================================
  # ğŸ“‹ ë¦´ë¦¬ìŠ¤ ìƒì„±
  # =============================================================================
  release:
    needs: [test, build, build-frontend, deploy-production]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: íƒœê·¸ ìƒì„±
        run: |
          export VERSION=$(git describe --tags --always)
          echo "Creating release v$VERSION"

      - name: ë¦´ë¦¬ìŠ¤ ìƒì„±
        uses: actions/create-release@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.VERSION }}
          release_name: Web3 Community v${{ env.VERSION }}
          body: |
            ## ğŸš€ Web3 Community Platform v${{ env.VERSION }}
            
            ### ğŸ†• ìƒˆë¡œìš´ ê¸°ëŠ¥
            - ëŒ“ê¸€ ì‹œìŠ¤í…œ ê°œì„ 
            - ì‹¤ì‹œê°„ WebSocket í†µì‹ 
            - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ê°•í™”
            - FastAPI ë°±ì—”ë“œ API ë¬¸ì„œí™”
            
            ### ğŸ› ë²„ê·¸ ìˆ˜ì •
            - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”
            - ì¸ì¦ ì‹œìŠ¤í…œ ì•ˆì •í™”
            - UI ë°˜ì‘ì„± ê°œì„ 
            
            ### ğŸ“Š ì„±ëŠ¥ ê°œì„ 
            - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”
            - API ì‘ë‹µ ì†ë„ í–¥ìƒ
            - í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ í¬ê¸° ê°ì†Œ
            
            ### ğŸ”§ ê¸°ìˆ ì  ë³€ê²½
            - Spring Boot 3.2 ì—…ê·¸ë ˆì´ë“œ
            - Vue.js 3.4ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
            - Docker ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ ì ìš©
            - CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì¶•
            
            ## ğŸ“¦ ì„¤ì¹˜ ë°©ë²•
            ### Docker
            ```bash
            git clone https://github.com/web3community/web3-community.git
            cd web3-community
            docker-compose up -d
            ```
            
            ### ê°œë³„ ì‹¤í–‰
            ```bash
            # ë°±ì—”ë“œ
            cd backend
            ./gradlew bootRun
            
            # í”„ë¡ íŠ¸ì—”ë“œ
            cd frontend
            npm run dev
            ```
            
            ## ğŸ”— ì ‘ì† ì •ë³´
            - ì›¹ì‚¬ì´íŠ¸: https://web3community.com
            - API ë¬¸ì„œ: https://api.web3community.com/docs
            - ëŒ€ì‹œë³´ë“œ: https://admin.web3community.com
            
            ## ğŸ™ ê°ì‚¬
            ëª¨ë“  ê¸°ì—¬í•´ì£¼ì‹  ê°œë°œìë¶„ë“¤ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.
          draft: false
          prerelease: false