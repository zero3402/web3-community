name: Performance Tests for Web3 Community

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # =============================================================================
  # ðŸ”— API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (K6)
  # =============================================================================
  api-performance:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker ì»´í¬ì¦ˆ ì‹¤í–‰
        run: |
          docker-compose -f docker-compose.yml up -d
          sleep 60

      - name: K6 API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          docker run --rm --network web3community_default \
            -v $(pwd)/tests/performance:/tests \
            grafana/k6 run \
            --env API_BASE_URL=http://api:8080 \
            /tests/api-load-test.js

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìˆ˜ì§‘
        run: |
          docker-compose logs k6 > k6-results.log 2>/dev/null || true

      - name: ì»¨í…Œì´ë„ˆ ì¤‘ì§€
        run: |
          docker-compose down

      - name: ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: k6-performance-results
          path: k6-results.log

  # =============================================================================
  # ðŸŒ ì›¹ì‚¬ì´íŠ¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (Lighthouse CI)
  # =============================================================================
  lighthouse:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¹Œë“œ
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Lighthouse CI í…ŒìŠ¤íŠ¸
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            http://localhost:3000
            http://localhost:3000/dashboard
            http://localhost:3000/community
            http://localhost:3000/posts/create
            http://localhost:3000/profile
          configPath: '.lighthouserci.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: ì„±ëŠ¥ ì ìˆ˜ í™•ì¸
        run: |
          if [ ! -f ".lighthouserci" ]; then
            echo "âš ï¸ Lighthouse ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # ì„±ëŠ¥ ì ìˆ˜ í™•ì¸ (ëª¨ë“  ì§€í‘œê°€ 90ì  ì´ìƒ)
          performance_score=$(cat lighthouseci-reports/metrics.json | jq '.categories.performance.score * 100 | floor')
          accessibility_score=$(cat lighthouseci-reports/metrics.json | jq '.categories.accessibility.score * 100 | floor')
          
          if [ $performance_score -lt 90 ]; then
            echo "âŒ ì„±ëŠ¥ ì ìˆ˜ ë¯¸ë‹¬ì„±: $performance_score/100"
            exit 1
          fi
          
          if [ $accessibility_score -lt 90 ]; then
            echo "âŒ ì ‘ê·¼ì„± ì ìˆ˜ ë¯¸ë‹¬ì„±: $accessibility_score/100"
            exit 1
          fi
          
          echo "âœ… ëª¨ë“  ì§€í‘œ í†µê³¼!"

  # =============================================================================
  # ðŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  # =============================================================================
  database-performance:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: perfuser
          POSTGRES_PASSWORD: perfpass
          POSTGRES_DB: perftestdb
        options: >-
          --health-cmd pg_isready -U perfuser -d perftestdb
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì„¤ì •
        run: |
          docker run --network host \
            -v $(pwd)/tests/database:/tests \
            postgres:15 \
            psql -h localhost \
            -U perfuser \
            -d perftestdb \
            -c "CREATE TABLE IF NOT EXISTS performance_test (id SERIAL PRIMARY KEY, data JSONB, created_at TIMESTAMP);"

      - name: ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          docker run --network host \
            -v $(pwd)/tests/database:/tests \
            postgres:15 \
            psql -h localhost \
            -U perfuser \
            -d perftestdb \
            -c "
              INSERT INTO performance_test (data, created_at) VALUES 
              (json_build_object('field1', 'value1', 'field2', 'value2', 'field3', 'value3'), NOW()),
              (json_build_object('field1', 'value1', 'name', 'test_user'), NOW()),
              (json_build_object('name', 'test_data'), NOW());
              
              -- ì¸ë±ìŠ¤ ìƒì„± í…ŒìŠ¤íŠ¸
              CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_performance_test_data ON performance_test USING GIN (to_tsvector('data'));
              
              -- ì¡°íšŒ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
              SELECT COUNT(*), data->>'field1' FROM performance_test WHERE data @> 'field1' AND created_at > NOW() - INTERVAL '1 hour';
              EXPLAIN ANALYZE SELECT * FROM performance_test WHERE data @> 'field1';
            "

  # =============================================================================
  # ðŸ” ë¶€í•˜ í…ŒìŠ¤íŠ¸ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜, ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰)
  # =============================================================================
  memory-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
        run: |
          echo "ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸:"
          free -h
          free -m
          ps aux --sort=-%mem | head -5

      - name: Docker ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
        run: |
          echo "Docker ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}"

  # =============================================================================
  # ðŸŒ ë„¤íŠ¸ì›Œí¬ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  # =============================================================================
  network-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë„¤íŠ¸ì›Œí¬ ëŒ€ê¸° ì‹œê°„ ì¸¡ì •
        run: |
          echo "API ëŒ€ê¸° ì‹œê°„ ì¸¡ì •:"
          time curl -o /dev/null -s -w '%{time_total}' http://nginx:80/api/v1/users || echo "timeout"
          
          echo "ì›¹ì‚¬ì´íŠ¸ ëŒ€ê¸° ì‹œê°„ ì¸¡ì •:"
          time curl -o /dev/null -s -w '%{time_total}' http://nginx:80/ || echo "timeout"

      - name: ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ í…ŒìŠ¤íŠ¸
        run: |
          echo "ë‹¤ìš´ë¡œë“œ í…ŒìŠ¤íŠ¸ (10ê°œ ë³‘ë ¬)..."
          
          for i in {1..10}; do
            curl -s -o /dev/null -w '%{time_total}' http://nginx:80/api/v1/posts &
          done
          
          echo "ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

  # =============================================================================
  # ðŸ“Š ê²°ê³¼ ë³´ê³ ì„œ ìƒì„±
  # =============================================================================
  performance-report:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [api-performance, lighthouse, database-performance]
    
    steps:
      - name: ì„±ëŠ¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: k6-performance-results
          path: k6-results.log

      - name: ì„±ëŠ¥ ë³´ê³ ì„œ ìƒì„±
        run: |
          cat > performance-report.md << EOF
          # Web3 Community Performance Report
          
          ## ðŸ“Š í…ŒìŠ¤íŠ¸ ê°œìš”
          - í…ŒìŠ¤íŠ¸ ë‚ ì§œ: $(date +'%Y-%m-%d %H:%M:%S')
          - ì»¤ë°‹ ë²„ì „: $(git describe --tags)
          
          ## ðŸ”— API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼
          $(cat k6-results.log | grep -E "(http_req_failed|http_reqs|iteration_duration)")
          
          ## ðŸŒ Lighthouse í…ŒìŠ¤íŠ¸ ê²°ê³¼
          $(cat lighthouseci-reports/metrics.json | jq -r '
            {
              "Performance": (.categories.performance.score * 100 | floor),
              "Accessibility": (.categories.accessibility.score * 100 | floor),
              "Best Practices": (.categories.best-practices.score * 100 | floor),
              "SEO": (.categories.seo.score * 100 | floor)
            }
          ')
          
          ## ðŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥
          - ì¿¼ë¦¬ ì‹œê°„: [ì¸¡ì • í•„ìš”]
          - ì¸ë±ìŠ¤ ì„±ëŠ¥: [ì¸¡ì • í•„ìš”]
          
          ## ðŸ§  ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤
          - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: [ì¸¡ì • í•„ìš”]
          - ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì‹œê°„: [ì¸¡ì • í•„ìš”]
          
          ## ðŸ“ˆ ê°œì„  ì‚¬í•­
          - API ì‘ë‹µ ì†ë„ ê°œì„ 
          - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”
          - ì›¹ì‚¬ì´íŠ¸ ë²ˆë“¤ë§ í¬ê¸° ìµœì í™”
          
          EOF

      - name: ë³´ê³ ì„œ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: performance-report.md

  # =============================================================================
  # ðŸš¨ ê²½ê³  ì•Œë¦¼
  # =============================================================================
  performance-alert:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [api-performance, lighthouse]
    
    steps:
      - name: ì„±ëŠ¥ ìž„ê³„ê°’ ê²€ì‚¬
        run: |
          # ì„±ëŠ¥ ìž„ê³„ê°’ (ì¡°ì • ê°€ëŠ¥)
          MAX_RESPONSE_TIME=1000  # 1ì´ˆ
          MIN_PERFORMANCE_SCORE=90  # 90ì  ì´ìƒ
          MIN_ACCESSIBILITY_SCORE=90  # 90ì  ì´ìƒ
          
          echo "ì„±ëŠ¥ ìž„ê³„ê°’ ê²€ì‚¬ ì¤‘..."
          
          # K6 ê²°ê³¼ í™•ì¸ (ì‹¤ì œë¡œëŠ” í…ŒìŠ¤íŠ¸ ê²°ê³¼ì—ì„œ ì¶”ì¶œ í•„ìš”)
          # Lighthouse ê²°ê³¼ í™•ì¸
          performance_score=$(cat lighthouseci-reports/metrics.json | jq '.categories.performance.score * 100 | floor')
          accessibility_score=$(cat lighthouseci-reports/metrics.json | jq '.categories.accessibility.score * 100 | floor')
          
          if [ $performance_score -lt $MIN_PERFORMANCE_SCORE ] || [ $accessibility_score -lt $MIN_ACCESSIBILITY_SCORE ]; then
            echo "ðŸš¨ ì„±ëŠ¥ ë¬¸ì œ ê°ì§€!"
            echo "Performance Score: $performance_score"
            echo "Accessibility Score: $accessibility_score"
            
            # Slack ë˜ëŠ” ì´ë©”ì¼ ì•Œë¦¼ (ì‹¤ì œ í™˜ê²½ì—ì„œ ì„¤ì • í•„ìš”)
            curl -X POST -H 'Content-type: application/json' \
              -d '{"text":"ðŸš¨ Web3 Community ë°°í¬ ì„±ëŠ¥ ë¬¸ì œ ê°ì§€\nPerformance: $performance_score/100\nAccessibility: $accessibility/100"}' \
              $SLACK_WEBHOOK_URL || echo "Slack webhook ì„¤ì • í•„ìš”"
            
            exit 1
          fi

  # =============================================================================
  # ðŸ“ˆ ì‹¤ì‹œê°„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì„¤ì • (ì„ íƒì‚¬í•­)
  # =============================================================================
  setup-monitoring:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì„¤ì •
        run: |
          echo "ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ì„ ì„¤ì •í•©ë‹ˆë‹¤."
          echo "ì„œë²„: https://web3community.com"
          echo "New Relic APM í†µí•©:"
          echo "- ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§"
          "- ì‹¤ì‹œê°„ ì‚¬ìš©ìž í™œë™ ì¶”ì "
          "- ì—ëŸ¬ ë° ì˜ˆì™¸ ëª¨ë‹ˆí„°ë§"
          echo ""
          echo "New Relic ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤."
          echo "1. New Relic ê³„ì • ìƒì„±"
          echo "2. APM ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •"
          echo "3. ì—ëŸ¬ ì¶”ì  ì„¤ì •"

  # =============================================================================
  # ðŸ”„ ìžë™ ì„±ëŠ¥ íšŒê·œ í…ŒìŠ¤íŠ¸
  # =============================================================================
  regression-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: íšŒê·œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ì´ì „ ë²„ì „ê³¼ ë¹„êµí•˜ëŠ” íšŒê·œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."
          echo "ì„±ëŠ¥ ì €í•˜ í™•ì¸ ë° íšŒê·€ íƒì§€"
          echo "ì´ì „ ë²„ì „ ê¸°ì¤€ê³¼ ë¹„êµí•˜ì—¬ ì„±ëŠ¥ ì €í•˜ ì‹œ ì•Œë¦¼"

# Performance Test Configuration (moved to separate config files)